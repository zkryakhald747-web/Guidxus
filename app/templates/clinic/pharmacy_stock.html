{% extends "base.html" %}
{% block breadcrumb %}Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© â†’ Ø§Ù„ÙƒÙ…ÙŠØ§Øª{% endblock %}
{% block content %}
<div class="card">
  <div class="card-head">
    <h3>ØªÙˆØ±ÙŠØ¯ / ØµØ±Ù / Ø¬Ø±Ø¯ â€” MAIN-PHARMA</h3>
    <form method="get" class="inline">
      <input name="q" value="{{ q }}" placeholder="ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø§Ø³Ù…">
      <button class="btn">ØªØµÙÙŠØ©</button>
      <a class="btn ghost" href="/clinic/pharmacy/stock">Ù…Ø³Ø­</a>
    </form>
  </div>

  {# ==== ØªÙ†Ø¨ÙŠÙ‡ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù†Ø¬Ø§Ø­/Ù…Ø¹Ù„ÙˆÙ…Ø©/Ø®Ø·Ø£) ==== #}
  {% set _msg  = msg or request.query_params.get('msg') %}
  {% set _need = need or request.query_params.get('need') %}
  {% set _have = have or request.query_params.get('have') %}

  {% if _msg %}
    {% if _msg in ['in_ok','out_ok','adjust_ok'] %}
      <div class="alert alert-success" role="alert" aria-live="polite">
        {{ 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.' if _msg=='in_ok'
           else 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµØ±Ù Ø¨Ù†Ø¬Ø§Ø­.' if _msg=='out_ok'
           else 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­.' }}
      </div>
    {% elif _msg == 'no_change' %}
      <div class="alert alert-info" role="status" aria-live="polite">
        Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙØ¹Ù„ÙŠØ©.
      </div>
    {% elif _msg == 'err_insufficient' %}
      <div class="alert alert-danger" role="alert" aria-live="assertive">
        Ù„Ø§ ÙŠÙ…ÙƒÙ† ØµØ±Ù <b>{{ _need }}</b>ØŒ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠÙ‹Ù‘Ø§ <b>{{ _have }}</b> ÙÙ‚Ø·.
      </div>
    {% elif _msg == 'err_unknown' %}
      <div class="alert alert-danger" role="alert" aria-live="assertive">
        Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
      </div>
    {% else %}
      <div class="alert alert-info" role="status">{{ _msg }}</div>
    {% endif %}
  {% endif %}

  <div class="grid-3 slim">
    
    <form class="stack" method="post" action="/clinic/pharmacy/movements/in" autocomplete="off">
      <h4>ØªÙˆØ±ÙŠØ¯</h4>
      <input class="drug-lookup" name="drug_q" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ (ØªØ¬Ø§Ø±ÙŠ/Ø¹Ù„Ù…ÙŠ)" list="drug-suggest" required>
      <input type="number" name="qty" min="1" placeholder="ÙƒÙ…ÙŠØ©" required>
      <input name="ref_note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      <button class="btn primary">Ø¥Ø¶Ø§ÙØ©</button>
    </form>

    
    <form class="stack" method="post" action="/clinic/pharmacy/movements/out" autocomplete="off">
      <h4>ØµØ±Ù</h4>
      <input class="drug-lookup" name="drug_q" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡" list="drug-suggest" required>
      <input type="number" name="qty" min="1" placeholder="ÙƒÙ…ÙŠØ©" required>
      <input name="ref_note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      <button class="btn danger">ØµØ±Ù</button>
    </form>

    
    <form class="stack" method="post" action="/clinic/pharmacy/movements/adjust" autocomplete="off">
      <h4>Ø¬Ø±Ø¯</h4>
      <input class="drug-lookup" name="drug_q" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡" list="drug-suggest" required>
      <input type="number" name="counted_qty" min="0" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙØ¹Ù„ÙŠØ©" required>
      <input name="ref_note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©">
      <button class="btn info">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯</button>
    </form>
  </div>

  <datalist id="drug-suggest"></datalist>

  <table class="tbl mt">
    <thead>
      <tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¹Ù„Ù…ÙŠ</th><th>Ø§Ù„Ø¬Ø±Ø¹Ø©</th><th>Ø§Ù„Ø´ÙƒÙ„</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø³Ø¬Ù„</th></tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.id }}</td>
        <td><b>{{ r.trade_name }}</b></td>
        <td class="muted">{{ r.generic_name }}</td>
        <td>{{ r.strength }}</td>
        <td>{{ r.form }}</td>
        <td>
          {% set qty = r.stock_main or 0 %}
          {% set cls = 'pill ok' if qty >= 5 else ('pill warn' if qty > 0 else 'pill danger') %}
          <span class="{{ cls }}">{{ qty }}</span>
        </td>
        <td>
          <a class="btn xs ghost" title="Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡"
             href="/clinic/pharmacy/movements/log?drug_id={{ r.id }}">ğŸ“‘</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="muted mt">
    ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø¬Ø±Ø¯ ÙŠØ­Ø³Ø¨ Ø§Ù„ÙØ±Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙŠÙØ³Ø¬Ù„ Ø­Ø±ÙƒØ© <code>adjust</code>.
  </div>
</div>

<script>
/* Autocomplete Ø¨Ø³ÙŠØ· Ø¹Ø¨Ø± /clinic/pharmacy/drugs/search?q= */
(function(){
  const inputs = document.querySelectorAll('input.drug-lookup');
  const datalist = document.getElementById('drug-suggest');

  async function fetchDrugs(q){
    if(!q || q.length < 2) { datalist.innerHTML = ''; return; }
    try{
      const url = '/clinic/pharmacy/drugs/search?q=' + encodeURIComponent(q);
      const r = await fetch(url, {headers: {'Accept':'application/json'}});
      if(!r.ok) return;
      const data = await r.json();
      datalist.innerHTML = (data.items || [])
        .map(it => `<option value="${it.label}"></option>`)
        .join('');
    }catch(_){}
  }

  inputs.forEach(inp => {
    inp.addEventListener('input', (e) => fetchDrugs(e.target.value));
    inp.addEventListener('focus', (e) => {
      if (e.target.value) fetchDrugs(e.target.value);
    });
  });
})();
</script>

<style>
/* ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø¯Ù…Ø¬Ø© */
.alert{padding:10px 12px;border-radius:8px;margin:10px 0;font-weight:600}
.alert-success{background:#e6f8ec;color:#1e8e3e}
.alert-info{background:#eef5ff;color:#0b57d0}
.alert-danger{background:#fde8e8;color:#b00020}

/* Ø£Ù„ÙˆØ§Ù† Ø£Ø²Ø±Ø§Ø± Ø®ÙÙŠÙØ© Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ù†Ø¸Ø§Ù…Ùƒ */
.btn.danger{background:#e53935;color:#fff}
.btn.info{background:#1976d2;color:#fff}

/* Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯ */
.pill { padding: 2px 8px; border-radius: 999px; font-weight:600; display:inline-block; }
.pill.ok { background:#e6f8ec; color:#1e8e3e; }
.pill.warn { background:#fff4e5; color:#b26a00; }
.pill.danger { background:#fde8e8; color:#b00020; }
</style>
{% endblock %}
