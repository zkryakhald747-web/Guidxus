{% extends "base.html" %}
{% block breadcrumb %}Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø·Ø¨ÙŠØ© â€º ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©{% endblock %}
{% block content %}
{% set F = form_vals or {} %}

<div class="card">

  <div class="card-head"><span class="card-icon">â•</span><h3>ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø©</h3></div>

  {% if msg == 'profile_saved' %}<div class="alert alert-success">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©.</div>{% endif %}
  {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}

  {% if patient_card %}
  <div class="patient-card">
    <div class="pc-head">
      <span class="pc-icon">ğŸ—‚ï¸</span>
      <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</h3>
    </div>
    <div class="pc-grid">
      <div><span>Ø§Ù„Ø§Ø³Ù…</span><strong>{{ patient_card.full_name }}</strong></div>
      {% if patient_card.trainee_no %}<div><span>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ</span><strong>{{ patient_card.trainee_no }}</strong></div>{% endif %}
      {% if patient_card.employee_no %}<div><span>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</span><strong>{{ patient_card.employee_no }}</strong></div>{% endif %}
      <div><span>Ø§Ù„Ø¬ÙˆØ§Ù„</span><strong>{{ patient_card.mobile or 'â€”' }}</strong></div>
      {% if patient_card.major %}<div><span>Ø§Ù„ØªØ®ØµØµ</span><strong>{{ patient_card.major }}</strong></div>{% endif %}
      {% if patient_card.college %}<div><span>Ø§Ù„ÙƒÙ„ÙŠØ©</span><strong>{{ patient_card.college }}</strong></div>{% endif %}
      <div>
        <span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ / Ø§Ù„Ø¹Ù…Ø±</span>
        <strong id="birthAgeDisplay">
          {{ patient_card.birth_date or 'â€”' }}
          {% if patient_card.birth_date and patient_card.age is not none %} ({{ patient_card.age }} Ø³Ù†Ø©){% endif %}
        </strong>
      </div>
    </div>
  </div>
  {% else %}
    <div class="alert alert-danger">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹. Ø§Ø±Ø¬Ø¹ ÙˆØ§Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ Ø£ÙˆÙ„Ù‹Ø§.</div>
  {% endif %}

  <form class="form" method="post" action="/clinic/visits/create" id="visitForm" autocomplete="off" novalidate>
    <input type="hidden" name="patient_key" value="{{ patient_card.patient_key if patient_card }}">

    {% if not patient_card.birth_date %}
    <h4 class="muted section-title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
    <div class="grid-basic align-end">
      <label class="field">
        <span class="lbl">Ø§Ù„Ø¹Ù…Ø± (Ø³Ù†ÙˆØ§Øª) <i class="req" aria-hidden="true">*</i></span>
        <input type="number" name="age_years" id="ageYears" min="0" max="120" placeholder="Ù…Ø«Ø§Ù„: 20" value="{{ F.get('age_years','') }}" required>
      </label>
    </div>
    {% endif %}


{% set _cv = F.get('chronic', []) %}
{% set chronic_vals = _cv %}
<fieldset class="form-group" style="margin-top:10px" dir="rtl">
  <legend style="font-weight:800; margin-bottom:6px">Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©</legend>

  <div class="chronic-row">
    <label class="chk">
      <input type="checkbox" name="chronic" value="Ø¶ØºØ·" {% if 'Ø¶ØºØ·' in chronic_vals %}checked{% endif %}> Ø¶ØºØ·
    </label>
    <label class="chk">
      <input type="checkbox" name="chronic" value="Ø³ÙƒØ±" {% if 'Ø³ÙƒØ±' in chronic_vals %}checked{% endif %}> Ø³ÙƒØ±
    </label>
    <label class="chk">
      <input type="checkbox" name="chronic" value="Ø±Ø¨Ùˆ" {% if 'Ø±Ø¨Ùˆ' in chronic_vals %}checked{% endif %}> Ø±Ø¨Ùˆ
    </label>
    <label class="chk">
      <input type="checkbox" name="chronic" value="ØµØ±Ø¹" {% if 'ØµØ±Ø¹' in chronic_vals %}checked{% endif %}> ØµØ±Ø¹
    </label>

    <label class="chk">
      <input id="chronic_other_ck" type="checkbox" name="chronic" value="Ø£Ø®Ø±Ù‰"
             {% if 'Ø£Ø®Ø±Ù‰' in chronic_vals or 'Ø§Ø®Ø±Ù‰' in chronic_vals %}checked{% endif %}>
      Ø£Ø®Ø±Ù‰
    </label>

    <input id="chronic_other_in" type="text" name="chronic_other"
           placeholder="Ø§Ø°ÙƒØ± Ø§Ù„Ù…Ø±Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†"
           value="{{ F.get('chronic_other','') }}"
           class="chronic-other-input">

    <small class="muted">Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª â€œØ£Ø®Ø±Ù‰â€ ÙØ§Ù„Ø­Ù‚Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ.</small>
  </div>
</fieldset>

<fieldset class="form-group" style="margin-top:10px" dir="rtl">
  <legend style="font-weight:800; margin-bottom:6px">Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</legend>

  
  <div class="grid-4 align-end">
    <label class="field">
      <span class="lbl">Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C): <i class="req" aria-hidden="true">*</i></span>
      <input type="number" step="0.1" min="34" max="42" name="temp" id="tempC" placeholder="37.0" value="{{ F.get('temp','') }}" required>
    </label>

    <label class="field">
      <span class="lbl">Ø§Ù„Ø¶ØºØ·:</span>
      <input type="text" name="bp" placeholder="120/80" value="{{ F.get('bp','') }}">
    </label>

    <label class="field">
      <span class="lbl">Ø§Ù„Ù†Ø¨Ø¶ (bpm):</span>
      <input type="number" min="30" max="200" name="pulse" placeholder="75" value="{{ F.get('pulse','') }}">
    </label>

    <label class="field">
      <span class="lbl">Ø§Ù„ØªÙ†ÙØ³ (rpm):</span>
      <input type="number" min="5" max="40" name="resp" placeholder="16" value="{{ F.get('resp','') }}">
    </label>
  </div>

<div class="grid-5 align-end" style="margin-top:10px">
  <label class="field">
    <span class="lbl">Ù†Ø³Ø¨Ø© Ø§Ù„Ø³ÙƒØ±  (mg/dL):</span>
    <input type="number" step="0.1" min="0" name="glucose_mg" value="{{ F.get('glucose_mg','') }}">
  </label>

  <label class="field">
    <span class="lbl">Oâ‚‚ (%):</span>
    <input type="number" step="0.1" min="0" max="100" name="o2_sat" value="{{ F.get('o2_sat','') }}">
  </label>

  <label class="field">
    <span class="lbl">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…):</span>
    <input type="number" step="0.1" min="1" max="500" name="weight_kg" id="weightKg" placeholder="Ù…Ø«Ø§Ù„: 70" value="{{ F.get('weight_kg','') }}">
  </label>

  <label class="field">
    <span class="lbl">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…):</span>
    <input type="number" step="0.1" min="30" max="300" name="height_cm" id="heightCm" placeholder="Ù…Ø«Ø§Ù„: 170" value="{{ F.get('height_cm','') }}">
  </label>

  
  <label class="field">
    <span class="lbl">BMI:</span>
    <div class="bmi-box" id="bmiBox" aria-live="polite"></div>
  </label>
</div>
</fieldset>

<fieldset class="form-group" style="margin-top:10px" dir="rtl">
  <legend style="font-weight:800; margin-bottom:6px">Ø§Ù„Ø´ÙƒÙˆÙ‰ Ùˆ Ø§Ù„ØªØ´Ø®ÙŠØµ</legend>
    <div class="grid-3 align-end">
      <label class="field">
        <span class="lbl">Ø§Ù„Ø´ÙƒÙˆÙ‰ Ùˆ Ù…Ø¯ØªÙ‡Ø§ <i class="req" aria-hidden="true">*</i></span>
        <textarea name="complaint" id="complaint" rows="2" placeholder="Ù†Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰..." required>{{ F.get('complaint','') }}</textarea>
      </label>
      <label class="field">
        <span class="lbl">Ø§Ù„ØªØ´Ø®ÙŠØµ <i class="req" aria-hidden="true">*</i></span>
        <textarea name="diagnosis" id="diagnosis" rows="2" placeholder="Ù†Øµ Ø§Ù„ØªØ´Ø®ÙŠØµ..." required>{{ F.get('diagnosis','') }}</textarea>
      </label>
      <label class="field">
        <span class="lbl">
			Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø·Ù‰
			<small class="muted">â€” ÙŠØ¬Ø¨ ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø¥Ø­Ø§Ù„Ø© Ø·Ø¨ÙŠØ©"</small>
		</span>
        <textarea name="notes" id="treatmentNotes" rows="2"
		          placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©...">{{ F.get('notes','') }}</textarea>
      </label>
    </div>
</fieldset>

<fieldset class="form-group" style="margin-top:10px" dir="rtl">
  <legend style="font-weight:800; margin-bottom:6px">Ø§Ù„ØªÙˆØµÙŠØ© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</legend>
    <div class="grid-3 align-end">
      {% set rec = F.get('recommendation','none') %}
      <label class="field">
        <span class="lbl">Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠØ©</span>
        <select name="recommendation" id="recType" onchange="toggleRecFields()">
          <option value="none"    {% if rec == 'none' %}selected{% endif %}>Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
          <option value="rest"    {% if rec == 'rest' %}selected{% endif %}>Ø±Ø§Ø­Ø©</option>
          <option value="referral"{% if rec == 'referral' %}selected{% endif %}>Ø¥Ø­Ø§Ù„Ø© Ø·Ø¨ÙŠØ©</option>
        </select>
      </label>

      <label class="field" id="refToWrap" style="display:none">
        <span class="lbl">Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (Ù…Ø³ØªØ´ÙÙ‰/Ø¹ÙŠØ§Ø¯Ø©)</span>
        <input type="text" name="rec_to" id="recTo" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ù„Ùƒ Ø®Ø§Ù„Ø¯" value="{{ F.get('rec_to','') }}">
      </label>

      <label class="field" id="refSummaryWrap" style="display:none">
        <span class="lbl">ÙˆØµÙ Ø§Ù„Ø­Ø§Ù„Ø©/Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</span>
        <input type="text" name="rec_summary" id="recSummary" placeholder="Ù…Ø«Ø§Ù„: Ø¢Ù„Ø§Ù… ØµØ¯Ø±ÙŠØ© Ù…ØªÙƒØ±Ø±Ø© Ø¨Ø­Ø§Ø¬Ø© Ù„ØªÙ‚ÙŠÙŠÙ… Ù‚Ù„Ø¨ÙŠ" value="{{ F.get('rec_summary','') }}">
      </label>

      <label class="field" id="restDaysWrap" style="display:none">
        <span class="lbl">Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø±Ø§Ø­Ø©</span>
        <input type="number" name="rest_days" id="restDays" min="1" max="30" value="{{ F.get('rest_days','') }}">
      </label>
    </div>
</fieldset>

<fieldset class="form-group" style="margin-top:10px" dir="rtl">
  <legend style="font-weight:800; margin-bottom:6px">Ø§Ù„ÙˆØµÙØ© Ø§Ù„Ø·Ø¨ÙŠØ©</legend>
    <div class="card" style="background:#f9fafb;border-color:#eef2f7">
      <div class="rx-search align-end">
        <label class="field" style="position:relative;margin:0">
          <span class="lbl">Ø§Ø®ØªØ± Ø¯ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙˆØ§Ø¡</span>
          <select id="drugSelect" style="padding:8px 10px; border:1px solid #e6e6e6; border-radius:10px; font-family:inherit; margin-bottom:6px;">
            <option value="">-- Ø§Ø®ØªØ± Ø¯ÙˆØ§Ø¡ --</option>
          </select>
          <input type="text" id="drugSearch" placeholder="Ø£Ùˆ Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
          <ul id="drugSuggest" class="suggest"></ul>
        </label>
        <button class="btn btn-secondary" type="button" onclick="addFromSelect()" style="margin:0">â• Ø¥Ø¶Ø§ÙØ©</button>
      </div>

      <div style="margin-top:10px">
        <table style="width:100%;border-collapse:separate;border-spacing:0 6px">
          <thead>
            <tr class="muted">
              <th style="text-align:right">Ø§Ù„Ø¯ÙˆØ§Ø¡</th>
              <th style="text-align:right;width:120px">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th style="text-align:right">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody id="rxTable"></tbody>
        </table>
      </div>
      <input type="hidden" name="rx_json" id="rxJson" value="{{ F.get('rx_json','') }}">
    </div>
</fieldset>

    <div class="actions" style="margin-top:12px">
      <button class="btn btn-primary" type="submit">Ø­ÙØ¸</button>
      <a class="btn" href="/clinic/">Ø¥Ù„ØºØ§Ø¡</a>
    </div>
  </form>
</div>

<style>
  /* ===== Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ===== */
  .patient-card{ margin-bottom:12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px }
  .patient-card .pc-head{ display:flex; align-items:center; gap:8px; margin-bottom:6px }
  .patient-card .pc-icon{ font-size:18px }
  .patient-card .pc-grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px 16px }
  .patient-card .pc-grid span{ display:block; color:#6b7280; font-size:.85rem }
  .patient-card .pc-grid strong{ display:block; color:#111827 }
  @media (max-width:700px){ .patient-card .pc-grid{ grid-template-columns: 1fr } }

  /* ===== Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ù‚Ø³Ø§Ù… ===== */
  .section-title{ margin:14px 0 8px }

  /* ===== Ø­Ù‚ÙˆÙ„ ÙÙˆØ±Ù… Ù…ÙˆØ­Ù‘Ø¯Ø© ===== */
  .field{ display:flex; flex-direction:column; gap:6px; color:#0f172a; font-weight:600 } /* ÙŠØ¬Ø¹Ù„ Ù†Øµ Ø§Ù„ØªØ³Ù…ÙŠØ© Ø¨Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ .lbl */
  .lbl{ display:inline-flex; align-items:center; gap:6px; font-weight:600; color:#0f172a }
  .req{ color:#ef4444; font-style:normal; font-weight:700; line-height:1 }

  /* Ø¥Ø¹Ø§Ø¯Ø© Ù†Ù…Ø· Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø­ØªÙ‰ Ù„Ø§ ØªØªØ£Ø«Ø± Ø¨ÙˆØ²Ù† Ø§Ù„Ø®Ø· ÙÙŠ .field */
  .field input,
  .field textarea,
  .field select{
    font-weight:400;
    color:#111827;
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:10px 12px;
    outline:0;
  }
  .field textarea{ resize:vertical; min-height:42px }
  .field input:focus,
  .field textarea:focus,
  .field select:focus{ border-color:#c9d4e0; box-shadow:0 0 0 3px rgba(18,164,180,.12) }

/* ===== Ø´Ø¨ÙƒØ§Øª Ø§Ù„ØªØ®Ø·ÙŠØ· ===== */
.align-end{ align-items:end }
.grid-basic{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px 16px }
.grid-3{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px 16px }
.grid-4{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px 16px }
.grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px 16px }
.grid-2{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px 16px }

/* Ø´Ø¨ÙƒØ© Ø¨Ø®Ù…Ø³Ø© Ø£Ø¹Ù…Ø¯Ø© (Ø³ÙƒØ± + O2 + ÙˆØ²Ù† + Ø·ÙˆÙ„ + BMI) */
.grid-5{ display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:12px 16px }

/* ØªØ¬Ø§ÙˆØ¨ */
@media (max-width:1100px){
  .grid-4{ grid-template-columns: repeat(2, minmax(0,1fr)) }
  .grid-5{ grid-template-columns: repeat(3, minmax(0,1fr)) }
}
@media (max-width:700px){
  .grid-2, .grid-3, .grid-4, .grid-5, .grid-basic, .grid{ grid-template-columns: 1fr }
}


  /* ===== Ø³Ø·Ø± Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø© (single row) ===== */
  .chronic-row{
    display:flex; align-items:center; gap:12px;
    white-space:nowrap; overflow-x:auto; padding-bottom:2px;
  }
  .chronic-row .chk{ display:inline-flex; align-items:center; gap:6px; margin:0 }
  .chronic-other-input{ min-width:220px }

  /* ===== Ù…Ø±Ø¨Ø¹ BMI ===== */
.bmi-box{
  padding:10px 12px;
  border-radius:10px;
  background:#f3f4f6;
  min-height:42px;
  display:flex;
  align-items:center;
  border:1px solid #e5e7eb;  /* Ù…Ø«Ù„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù€ input */
  color:#111827;
}

  /* ===== Ø¨Ø­Ø« Ø§Ù„Ø£Ø¯ÙˆÙŠØ© & Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ===== */
  .rx-search{ display:grid; grid-template-columns: 1fr auto; gap:12px }
  #drugSearch { width:100% }
  .suggest{
    position:absolute; right:0; left:0; top:100%; z-index:10; list-style:none; margin:4px 0 0; padding:0;
    background:#fff; border:1px solid #e5e7eb; border-radius:8px; max-height:220px; overflow:auto; display:none
  }
  .suggest li{ padding:8px 10px; cursor:pointer }
  .suggest li:hover{ background:#f3f4f6 }
</style>

<script>
  // ===== ØªÙˆØµÙŠØ© ØªÙƒÙŠÙ‘ÙÙŠØ© =====
  function toggleRecFields() {
    var v = document.getElementById('recType').value;
    document.getElementById('restDaysWrap').style.display   = (v === 'rest')     ? 'block' : 'none';
    document.getElementById('refToWrap').style.display      = (v === 'referral') ? 'block' : 'none';
    document.getElementById('refSummaryWrap').style.display = (v === 'referral') ? 'block' : 'none';
    if (v !== 'rest')     document.getElementById('restDays').value = '';
    if (v !== 'referral'){ document.getElementById('recTo').value=''; document.getElementById('recSummary').value=''; }

    // === Ø¥Ù„Ø²Ø§Ù… "Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø·Ù‰" Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© ===
    var tn = document.getElementById('treatmentNotes') || document.querySelector('textarea[name="notes"]');
    if (tn){
      if (v === 'referral'){
        tn.setAttribute('required','required');
        tn.placeholder = 'Ù…Ø·Ù„ÙˆØ¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ©...';
      } else {
        tn.removeAttribute('required');
        tn.placeholder = 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©...';
      }
    }
  }
  toggleRecFields();

  // ===== ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø­Ù‚Ù„ "Ø£Ø®Ø±Ù‰" ÙÙŠ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø© =====
  (function(){
    var ck = document.getElementById('chronic_other_ck');
    var inp = document.getElementById('chronic_other_in');
    function sync(){
      if (!ck || !inp) return;
      inp.disabled = !ck.checked;
      inp.required = ck.checked;
      if (!ck.checked && !inp.value) { inp.value = ''; }
    }
    if (ck) { ck.addEventListener('change', sync); }
    sync();
  })();

  // ===== BMI Ø­ÙŠÙ‘ =====
  const w = document.getElementById('weightKg');
  const h = document.getElementById('heightCm');
  const bmiBox = document.getElementById('bmiBox');
  function updBMI(){
    const W = parseFloat((w&&w.value)||'');
    const H = parseFloat((h&&h.value)||'');
    if(!W || !H){ bmiBox.textContent = ''; return; }
    const m = H/100.0;
    if(m<=0){ bmiBox.textContent=''; return; }
    const bmi = (W/(m*m));
    bmiBox.textContent = 'BMI (ØªÙ‚Ø±ÙŠØ¨ÙŠ): ' + (Math.round(bmi*10)/10);
  }
  if(w) w.addEventListener('input', updBMI);
  if(h) h.addEventListener('input', updBMI);
  updBMI(); // Ù„Ùˆ ÙƒØ§Ù†Øª Ù‚ÙŠÙ… Ù…Ø­Ù…Ù‘Ù„Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§

  // ===== ØªØ­Ù‚Ù‘Ù‚ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ· Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ =====
  document.getElementById('visitForm').addEventListener('submit', function(e){
    e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    
    const temp = document.getElementById('tempC');
    const comp = document.getElementById('complaint');
    const diag = document.getElementById('diagnosis');
    {% if not patient_card.birth_date %}
      const age = document.getElementById('ageYears');
      if(!age.value){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù…Ø± (Ø³Ù†ÙˆØ§Øª).'); return; }
    {% endif %}
    if(!temp.value){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©.'); return; }
    if(!comp.value.trim()){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©/Ø§Ù„Ø´ÙƒÙˆÙ‰.'); return; }
    if(!diag.value.trim()){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ.'); return; }

    // === Ø¬Ø¯ÙŠØ¯: Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø·Ù‰ Ø¥Ù„Ø²Ø§Ù…ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© ===
    const recType = document.getElementById('recType').value;
    const treat = document.getElementById('treatmentNotes') || document.querySelector('textarea[name="notes"]');
    if (recType === 'referral' && (!treat || !treat.value.trim())){
      alert('Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø­Ø§Ù„Ø© Ø·Ø¨ÙŠØ©ØŒ ÙŠØ¬Ø¨ ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚Ù„ "Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø·Ù‰".');
      return;
    }

    // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
    const formData = new FormData(this);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø± AJAX
    console.log('Submitting form...');
    fetch('/clinic/visits/create', {
      method: 'POST',
      body: formData
    })
    .then(r => {
      console.log('Response status:', r.status);
      console.log('Response headers:', r.headers.get('content-type'));
      return r.json();
    })
    .then(data => {
      console.log('Response data:', data);
      if (!data.success) {
        alert('Ø®Ø·Ø£: ' + (data.error || 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©'));
        return;
      }
      
      // Ø§Ù„Ø²ÙŠØ§Ø±Ø© ØªÙ… Ø­ÙØ¸Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­');
      
      console.log('Visit ID:', data.visit_id, 'Recommendation:', data.recommendation);
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¥Ø­Ø§Ù„Ø© Ø£Ùˆ Ø±Ø§Ø­Ø©ØŒ Ø§ÙØªØ­ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      if (data.recommendation === 'rest' && data.visit_id) {
        // Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø§Ø­Ø©
        console.log('Opening rest notice for visit:', data.visit_id);
        window.open('/clinic/reports/rest_notice/by_visit?visit_id=' + data.visit_id, '_blank');
      } else if (data.recommendation === 'referral' && data.visit_id) {
        // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ©
        console.log('Opening referral notice for visit:', data.visit_id);
        window.open('/clinic/reports/referral_notice/by_visit?visit_id=' + data.visit_id, '_blank');
      } else {
        // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø§Ù„Ø© ÙˆÙ„Ø§ Ø±Ø§Ø­Ø©ØŒ Ø£ØºÙ„Ù‚ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø§Ø±Ø¬Ø¹
        console.log('No recommendation, redirecting...');
        setTimeout(() => {
          window.location.href = '/clinic/?msg=visit_saved';
        }, 500);
      }
    })
    .catch(err => {
      console.error('Request error:', err);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + err.message);
    });
  });

  // ===== ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡: Autocomplete + Dropdown =====
  const drugInput = document.getElementById('drugSearch');
  const drugSelect = document.getElementById('drugSelect');
  const suggest   = document.getElementById('drugSuggest');
  const tableBody = document.getElementById('rxTable');
  const rxJson    = document.getElementById('rxJson');
  const rxMap     = new Map(); // id -> {label, qty, note}

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙˆÙ…Ù„Ø¡ Ø§Ù„Ù€ dropdown
  function loadAllDrugs(){
    fetch('/clinic/pharmacy/drugs/search?q=')
      .then(r=>r.json())
      .then(data=>{
        const items = (data && data.items) || [];
        if (items.length) {
          // Ù…Ù„Ø¡ Ø§Ù„Ù€ dropdown
          items.forEach(it => {
            const opt = document.createElement('option');
            opt.value = it.id;
            opt.textContent = it.label;
            drugSelect.appendChild(opt);
          });
        } else {
          console.warn('No drugs found');
        }
      })
      .catch(e=>console.error('Failed to load drugs:', e));
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  document.addEventListener('DOMContentLoaded', loadAllDrugs);

  let debounceT = null;
  if (drugInput){
    drugInput.addEventListener('input', function(){
      const q = this.value.trim();
      clearTimeout(debounceT);
      if (!q){ suggest.style.display='none'; suggest.innerHTML=''; return; }
      debounceT = setTimeout(()=> searchDrugs(q), 220);
    });
  }

  function searchDrugs(q){
    fetch(`/clinic/pharmacy/drugs/search?q=${encodeURIComponent(q)}`)
      .then(r=>r.json())
      .then(data=>{
        const items = (data && data.items) || [];
        if (!items.length){ suggest.style.display='none'; suggest.innerHTML=''; return; }
        suggest.innerHTML = items.map(it => `<li data-id="${it.id}" data-label="${escapeHtml(it.label)}">${escapeHtml(it.label)}</li>`).join('');
        suggest.style.display = 'block';
      })
      .catch(()=>{ suggest.style.display='none'; });
  }

  suggest.addEventListener('click', function(e){
    const li = e.target.closest('li');
    if (!li) return;
    const id = parseInt(li.getAttribute('data-id'), 10);
    const label = li.getAttribute('data-label');
    drugInput.value = label;
    suggest.style.display='none';
    addDrug(id, label);
  });

  document.addEventListener('click', function(e){
    if (!suggest.contains(e.target) && e.target !== drugInput) suggest.style.display='none';
  });

  function addFromSelect(){
    const selectedId = parseInt(drugSelect.value, 10);
    const selectedOption = drugSelect.options[drugSelect.selectedIndex];
    if (!selectedId || selectedId <= 0){ alert('Ø§Ø®ØªØ± Ø¯ÙˆØ§Ø¡Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.'); return; }
    const label = selectedOption.textContent;
    addDrug(selectedId, label);
    drugSelect.value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù€ dropdown
  }

  function addFromInput(){
    const li = suggest.querySelector('li');
    if (!li){ alert('Ø§Ø®ØªØ± Ø¯ÙˆØ§Ø¡Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª.'); return; }
    const id = parseInt(li.getAttribute('data-id'),10);
    const label = li.getAttribute('data-label');
    addDrug(id, label);
  }

  function addDrug(id, label){
    if (rxMap.has(id)) return;
    rxMap.set(id, {label: label, qty: 1, note: ''});
    drugInput.value = '';
    redraw();
  }

  function redraw(){
    let rows = '';
    rxMap.forEach((v, id)=>{
      rows += `
      <tr style="background:#fff;border:1px solid #eee">
        <td style="padding:8px 10px">${escapeHtml(v.label)}</td>
        <td style="padding:8px 10px"><input type="number" min="1" max="999" value="${v.qty}" style="width:100%" oninput="updQty(${id}, this.value)"></td>
        <td style="padding:8px 10px"><input type="text" value="${escapeHtml(v.note||'')}" placeholder="ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…..." style="width:100%" oninput="updNote(${id}, this.value)"></td>
        <td style="padding:8px 10px;text-align:center"><button class="btn" type="button" onclick="delDrug(${id})">âŒ</button></td>
      </tr>`;
    });
    tableBody.innerHTML = rows;
    syncHidden();
  }

  function updQty(id, v){ const n=parseInt(v,10); if(!n||n<1)return; const o=rxMap.get(id); if(!o)return; o.qty=n; syncHidden(); }
  function updNote(id, v){ const o=rxMap.get(id); if(!o)return; o.note=v; syncHidden(); }
  function delDrug(id){ rxMap.delete(id); redraw(); }

  function syncHidden(){
    const arr=[]; rxMap.forEach((v,id)=>arr.push({drug_id:id, label:v.label, qty:v.qty, note:v.note}));
    rxJson.value = arr.length ? JSON.stringify(arr) : '';
  }

  // ===== Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙˆØµÙØ© Ù…Ù† rx_json Ø¥Ù† ÙˆÙØ¬Ø¯Øª Ø¨Ø¹Ø¯ Ø®Ø·Ø£ =====
  try{
    const pre = rxJson.value && JSON.parse(rxJson.value);
    if (Array.isArray(pre)){
      pre.forEach(it=>{
        if(!it || rxMap.has(it.drug_id)) return;
        rxMap.set(parseInt(it.drug_id,10), {label: it.label || ('#'+it.drug_id), qty: parseInt(it.qty||1,10), note: it.note || ''});
      });
      redraw();
    }
  }catch(_){}

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ===== Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø± Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ =====
  function calculateAge(birthDateStr) {
    if (!birthDateStr) return null;
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® (YYYY-MM-DD Ø£Ùˆ DD/MM/YYYY)
    let birthDate;
    if (birthDateStr.includes('-')) {
      // YYYY-MM-DD
      birthDate = new Date(birthDateStr);
    } else if (birthDateStr.includes('/')) {
      // DD/MM/YYYY
      const parts = birthDateStr.split('/');
      if (parts.length === 3) {
        birthDate = new Date(parts[2], parts[1]-1, parts[0]);
      }
    } else {
      return null;
    }
    
    if (isNaN(birthDate)) return null;
    
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    return age >= 0 ? age : null;
  }

  // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  document.addEventListener('DOMContentLoaded', function() {
    const display = document.getElementById('birthAgeDisplay');
    if (display) {
      const birthDateText = display.textContent.split(' ')[0]; // Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
      const age = calculateAge(birthDateText);
      if (age !== null && birthDateText !== 'â€”') {
        display.textContent = birthDateText + ' (' + age + ' Ø³Ù†Ø©)';
      }
    }
  });
</script>
{% endblock %}
