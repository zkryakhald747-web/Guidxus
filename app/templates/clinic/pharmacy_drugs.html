{% extends "base.html" %}
{% block breadcrumb %}Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© â†’ Ø§Ù„Ø£ØµÙ†Ø§Ù{% endblock %}
{% block content %}
<div class="grid-2">
  <div class="card">
    <div class="card-head">
      <h3>Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
      <form method="get" class="inline">
        <input name="q" value="{{ q }}" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ / Ø§Ù„Ø¹Ù„Ù…ÙŠ / Ø§Ù„Ø´Ø±ÙƒØ©" autofocus>
        <button class="btn">Ø¨Ø­Ø«</button>
        <a class="btn ghost" href="/clinic/pharmacy/drugs">Ù…Ø³Ø­</a>
      </form>
    </div>

    
    <div class="toolbar">
      <input id="localFilter" placeholder="ÙÙ„ØªØ±Ø© ÙÙˆØ±ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€¦" />
      <span class="muted sm">Ø¥Ø¸Ù‡Ø§Ø±</span>
      <select id="pageSize">
        <option>25</option><option selected>50</option><option>100</option>
      </select>
      <span class="muted sm">ØµÙ/Ø§Ù„ØµÙØ­Ø©</span>
    </div>

    <div class="tbl-wrap">
      <table class="tbl" id="tbl-drugs">
        <thead>
          <tr>
            <th data-sort="num" style="width:72px">#</th>
            <th data-sort="txt">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ â¬</th>
            <th data-sort="txt">Ø§Ù„Ø¹Ù„Ù…ÙŠ</th>
            <th data-sort="txt">Ø§Ù„Ø¬Ø±Ø¹Ø©</th>
            <th data-sort="txt">Ø§Ù„Ø´ÙƒÙ„</th>
            <th data-sort="txt">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th data-sort="txt">Ø§Ù„Ø´Ø±ÙƒØ©</th>
            <th data-sort="num" style="width:90px">Ø±ØµÙŠØ¯</th>
            <th style="width:150px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr data-id="{{ r.id }}">
            <td class="num">{{ r.id }}</td>
            <td class="b">{{ r.trade_name }}</td>
            <td class="muted">{{ r.generic_name }}</td>
            <td>{{ r.strength }}</td>
            <td>{{ r.form }}</td>
            <td>{{ r.unit or 'â€”' }}</td>
            <td class="muted">{{ r.manufacturer }}</td>
            <td class="num">
              {% set qty = r.stock_main or 0 %}
              {% set cls = 'pill ok' if qty >= 5 else ('pill warn' if qty > 0 else 'pill danger') %}
              <span class="{{ cls }}">{{ qty }}</span>
            </td>
            <td>
              <button class="btn xs" data-edit
                      data-trade="{{ r.trade_name|e }}"
                      data-generic="{{ r.generic_name|e }}"
                      data-strength="{{ r.strength|e }}"
                      data-form="{{ r.form|e }}"
                      data-manufacturer="{{ r.manufacturer|e }}"
                      data-id="{{ r.id }}">ØªØ¹Ø¯ÙŠÙ„</button>

              <a class="btn xs ghost" title="Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª" 
                 href="/clinic/pharmacy/movements/log?drug_id={{ r.id }}">ğŸ“‘</a>

              <a class="btn xs" title="Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚" 
                 href="/inventory/supply-to-boxes?drug_id={{ r.id }}&drug_name={{ r.trade_name|e }}">ğŸ’‰</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    
    <div class="pager">
      <button class="btn ghost" id="prevPage">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <span class="muted" id="pageInfo">ØµÙØ­Ø© 1/1</span>
      <button class="btn ghost" id="nextPage">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>

    <div class="muted mt">
      ØªÙ„Ù…ÙŠØ­: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù„ÙØ±Ø² Ø§Ù„Ø¬Ø¯ÙˆÙ„. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©.
    </div>
  </div>

  <div class="card">
    <div class="card-head"><h3>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h3></div>
    <form method="post" action="/clinic/pharmacy/drugs/create" class="form-grid">
      <input name="trade_name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ *" required>
      <input name="generic_name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ">
      <input name="strength" placeholder="Ø§Ù„Ø¬Ø±Ø¹Ø© (Ù…Ø«Ø§Ù„: 500 mg)">
      <input name="form" placeholder="Ø§Ù„Ø´ÙƒÙ„ (Tablet / Syrup...)">
      <input name="manufacturer" placeholder="Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø©">
      <select name="unit" placeholder="ÙˆØ­Ø¯Ø© Ø§Ù„Ø¯ÙˆØ§Ø¡">
        <option value="">-- Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø© Ø§Ù„Ø¯ÙˆØ§Ø¡ --</option>
        <option value="Tablet">Ù‚Ø±Øµ (Tablet)</option>
        <option value="Capsule">ÙƒØ¨Ø³ÙˆÙ„Ø© (Capsule)</option>
        <option value="Ampoule">Ø£Ù…Ø¨ÙˆÙ„Ø© (Ampoule)</option>
        <option value="Vial">Ù‚Ø§Ø±ÙˆØ±Ø© (Vial)</option>
        <option value="Bottle">Ø²Ø¬Ø§Ø¬Ø© (Bottle)</option>
        <option value="Syrup">Ø´Ø±Ø§Ø¨ (Syrup)</option>
        <option value="Suspension">Ù…Ø¹Ù„Ù‚ (Suspension)</option>
        <option value="Powder">Ø¨ÙˆØ¯Ø±Ø© (Powder)</option>
        <option value="Cream">ÙƒØ±ÙŠÙ… (Cream)</option>
        <option value="Ointment">Ù…Ø±Ù‡Ù… (Ointment)</option>
        <option value="Gel">Ø¬Ù„ (Gel)</option>
        <option value="Lotion">ØºØ³ÙˆÙ„ (Lotion)</option>
        <option value="Spray">Ø¨Ø®Ø§Ø® (Spray)</option>
        <option value="Solution">Ù…Ø­Ù„ÙˆÙ„ (Solution)</option>
        <option value="Drops">Ù‚Ø·Ø±Ø§Øª (Drops)</option>
        <option value="Patch">Ù„ØµÙ‚Ø© (Patch)</option>
        <option value="Suppository">ØªØ­Ù…ÙŠÙ„Ø© (Suppository)</option>
        <option value="Injection">Ø­Ù‚Ù†Ø© (Injection)</option>
        <option value="ml">Ù…Ù„ÙŠ Ù„ØªØ± (ml)</option>
        <option value="gram">ØºØ±Ø§Ù… (gram)</option>
        <option value="unit">ÙˆØ­Ø¯Ø© (unit)</option>
      </select>
      <div class="actions"><button class="btn primary">Ø­ÙØ¸</button></div>
    </form>

    <div class="muted mt">Ø§Ù„Ø±ØµÙŠØ¯ ÙŠØ¸Ù‡Ø± Ù…Ù† Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø· (MAIN-PHARMA).</div>
  </div>
</div>


<div class="modal" id="editModal" aria-hidden="true" role="dialog">
  <div class="modal-backdrop" data-close></div>
  <div class="modal-card" role="document">
    <div class="modal-head">
      <h4>ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù</h4>
      <button class="icon-btn" title="Ø¥ØºÙ„Ø§Ù‚" aria-label="Ø¥ØºÙ„Ø§Ù‚" data-close>Ã—</button>
    </div>
    <form method="post" action="/clinic/pharmacy/drugs/update" class="form-grid" id="editForm">
      <input type="hidden" name="drug_id" id="f_id">
      <input name="trade_name" id="f_trade" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ *" required>
      <input name="generic_name" id="f_generic" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ">
      <input name="strength" id="f_strength" placeholder="Ø§Ù„Ø¬Ø±Ø¹Ø©">
      <input name="form" id="f_form" placeholder="Ø§Ù„Ø´ÙƒÙ„">
      <input name="manufacturer" id="f_manu" placeholder="Ø§Ù„Ø´Ø±ÙƒØ©">
      <select name="unit" id="f_unit" placeholder="ÙˆØ­Ø¯Ø© Ø§Ù„Ø¯ÙˆØ§Ø¡">
        <option value="">-- Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø© --</option>
        <option value="Tablet">Ù‚Ø±Øµ (Tablet)</option>
        <option value="Capsule">ÙƒØ¨Ø³ÙˆÙ„Ø© (Capsule)</option>
        <option value="Ampoule">Ø£Ù…Ø¨ÙˆÙ„Ø© (Ampoule)</option>
        <option value="Vial">Ù‚Ø§Ø±ÙˆØ±Ø© (Vial)</option>
        <option value="Bottle">Ø²Ø¬Ø§Ø¬Ø© (Bottle)</option>
        <option value="Syrup">Ø´Ø±Ø§Ø¨ (Syrup)</option>
        <option value="Suspension">Ù…Ø¹Ù„Ù‚ (Suspension)</option>
        <option value="Powder">Ø¨ÙˆØ¯Ø±Ø© (Powder)</option>
        <option value="Cream">ÙƒØ±ÙŠÙ… (Cream)</option>
        <option value="Ointment">Ù…Ø±Ù‡Ù… (Ointment)</option>
        <option value="Gel">Ø¬Ù„ (Gel)</option>
        <option value="Lotion">ØºØ³ÙˆÙ„ (Lotion)</option>
        <option value="Spray">Ø¨Ø®Ø§Ø® (Spray)</option>
        <option value="Solution">Ù…Ø­Ù„ÙˆÙ„ (Solution)</option>
        <option value="Drops">Ù‚Ø·Ø±Ø§Øª (Drops)</option>
        <option value="Patch">Ù„ØµÙ‚Ø© (Patch)</option>
        <option value="Suppository">ØªØ­Ù…ÙŠÙ„Ø© (Suppository)</option>
        <option value="Injection">Ø­Ù‚Ù†Ø© (Injection)</option>
        <option value="ml">Ù…Ù„ÙŠ Ù„ØªØ± (ml)</option>
        <option value="gram">ØºØ±Ø§Ù… (gram)</option>
        <option value="unit">ÙˆØ­Ø¯Ø© (unit)</option>
      </select>
      <div class="actions">
        <button class="btn" data-close type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" type="submit">Ø­ÙØ¸</button>
      </div>
    </form>
  </div>
</div>


<div id="toast" class="toast" aria-live="polite"></div>

<script>
(function(){
  const tbl = document.getElementById('tbl-drugs');
  const tbody = tbl.tBodies[0];
  const rowsAll = Array.from(tbody.rows);
  const localFilter = document.getElementById('localFilter');
  const pageSizeSel = document.getElementById('pageSize');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');
  const pageInfo = document.getElementById('pageInfo');
  const toast = document.getElementById('toast');

  // === ÙØ±Ø² Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ø¹Ù…ÙˆØ¯ ===
  const getText = (td) => (td?.textContent || '').trim();
  const parseNum = (s) => parseFloat(s.replace(/[^\d.-]/g,'')) || 0;
  tbl.querySelectorAll('th[data-sort]').forEach((th, idx) => {
    th.style.cursor = 'pointer';
    let asc = true;
    th.addEventListener('click', () => {
      const type = th.dataset.sort;
      currentRows.sort((a,b) => {
        const A = getText(a.cells[idx]);
        const B = getText(b.cells[idx]);
        if (type === 'num') return (parseNum(A) - parseNum(B)) * (asc?1:-1);
        return A.localeCompare(B, 'ar') * (asc?1:-1);
      });
      asc = !asc; render();
    });
  });

  // === ÙÙ„ØªØ±Ø© ÙÙˆØ±ÙŠØ© ===
  let currentRows = rowsAll.slice();
  localFilter.addEventListener('input', () => {
    const q = localFilter.value.trim().toLowerCase();
    currentRows = rowsAll.filter(tr => tr.textContent.toLowerCase().includes(q));
    page = 1; render();
  });

  // === Pagination Ø¨Ø³ÙŠØ· ===
  let page = 1;
  function pageSize(){ return parseInt(pageSizeSel.value,10) || 50; }
  pageSizeSel.addEventListener('change', () => { page = 1; render(); });
  prevBtn.addEventListener('click', () => { if(page>1){ page--; render(); }});
  nextBtn.addEventListener('click', () => {
    const max = Math.max(1, Math.ceil(currentRows.length / pageSize()));
    if(page<max){ page++; render(); }
  });

  function render(){
    // ØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø³Ù… ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    tbody.innerHTML = '';
    const ps = pageSize();
    const start = (page-1)*ps;
    const chunk = currentRows.slice(start, start+ps);
    chunk.forEach(r => tbody.appendChild(r));
    const max = Math.max(1, Math.ceil(currentRows.length / ps));
    pageInfo.textContent = `ØµÙØ­Ø© ${page}/${max}`;
    prevBtn.disabled = (page<=1);
    nextBtn.disabled = (page>=max);
    if(currentRows.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 8; td.className='muted center';
      td.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.';
      tr.appendChild(td); tbody.appendChild(tr);
    }
  }
  render();

  // === Modal: ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ ÙˆØªØ¹Ø¨Ø¦Ø© ===
  const modal = document.getElementById('editModal');
  const form = document.getElementById('editForm');
  const f_id = document.getElementById('f_id');
  const f_trade = document.getElementById('f_trade');
  const f_generic = document.getElementById('f_generic');
  const f_strength = document.getElementById('f_strength');
  const f_form = document.getElementById('f_form');
  const f_manu = document.getElementById('f_manu');

  function openModal(){ modal.setAttribute('aria-hidden','false'); document.body.classList.add('modal-open'); f_trade.focus(); }
  function closeModal(){ modal.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); }

  document.addEventListener('click', (e)=>{
    if(e.target.matches('[data-edit]')){
      const btn = e.target;
      f_id.value = btn.dataset.id;
      f_trade.value = btn.dataset.trade || '';
      f_generic.value = btn.dataset.generic || '';
      f_strength.value = btn.dataset.strength || '';
      f_form.value = btn.dataset.form || '';
      f_manu.value = btn.dataset.manufacturer || '';
      openModal();
    }
    if(e.target.matches('[data-close]')){ closeModal(); }
  });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeModal(); }});

  // Toast Ø¨Ø³ÙŠØ· Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Ø§Ù„Ø­ÙØ¸
  const params = new URLSearchParams(location.search);
  if(params.get('msg') === 'updated'){ showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª âœ…'); }
  function showToast(text){
    toast.textContent = text;
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 2500);
  }
})();
</script>

<style>
/* ØªØ®Ø·ÙŠØ· */
.toolbar{display:flex;gap:8px;align-items:center;margin:8px 0}
.toolbar input{max-width:280px}
.tbl-wrap{max-height:60vh;overflow:auto;border:1px solid var(--border,#e5e7eb);border-radius:10px}

/* Ø±Ø£Ø³ Ø«Ø§Ø¨Øª */
.tbl thead th{position:sticky;top:0;background:#fff;z-index:1}

/* Ù…Ø­Ø§Ø°Ø§Ø© Ø£Ø±Ù‚Ø§Ù… */
.num{text-align:center}
.b{font-weight:600}

/* Pager */
.pager{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px}

/* Modal */
.modal[aria-hidden="true"]{display:none}
.modal{position:fixed;inset:0;z-index:1000}
.modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
.modal-card{position:relative;margin:5vh auto 0;max-width:560px;background:#fff;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.15);padding:16px}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.icon-btn{border:none;background:#f2f4f7;border-radius:8px;padding:4px 10px;cursor:pointer}
.modal-open{overflow:hidden}

/* Toast */
.toast{position:fixed;bottom:18px;right:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.25s}
.toast.show{opacity:1;transform:translateY(0)}

/* Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯ */
.pill { padding: 2px 8px; border-radius: 999px; font-weight:600; display:inline-block; }
.pill.ok { background:#e6f8ec; color:#1e8e3e; }
.pill.warn { background:#fff4e5; color:#b26a00; }
.pill.danger { background:#fde8e8; color:#b00020; }

/* ØµÙØºØ± Ù†Øµ */
.sm{font-size:.9em}
.center{text-align:center}
</style>
{% endblock %}
