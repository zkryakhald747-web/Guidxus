{% extends "base.html" %}
{% block breadcrumb %}Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø·Ø¨ÙŠØ© â€º Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ{% endblock %}
{% block content %}

{# Ù…Ø§ÙƒØ±Ùˆ Ù„ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ù…Ù† Ø£ÙŠ ÙÙˆØ§ØµÙ„ Ø£Ùˆ ÙƒØ³ÙˆØ± Ø¹Ø´Ø±ÙŠØ© #}
{% macro id_clean(v) -%}
  {{ ('' ~ v).replace(',', '').split('.')[0] }}
{%- endmacro %}

<div class="card" dir="rtl">
  <div class="card-head">
    <span class="card-icon">ğŸ§‘â€âš•ï¸</span>
    <h3>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹</h3>
  </div>

  {% if msg == 'profile_saved' %}
    <div class="alert alert-success">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­.</div>
  {% endif %}
  {% if msg == 'profile_updated' %}
    <div class="alert alert-success">ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­.</div>
  {% endif %}
  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <div class="actions" style="margin-bottom:10px">
    <a class="btn {% if tab=='create' %}btn-primary{% else %}btn-secondary{% endif %}" href="/clinic/patients?tab=create">Ø¥Ù†Ø´Ø§Ø¡/Ø¥Ø¯Ø§Ø±Ø© Ù…Ù„Ù</a>
    <a class="btn {% if tab=='search' %}btn-primary{% else %}btn-secondary{% endif %}" href="/clinic/patients?tab=search">Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù</a>
  </div>

  {% if tab == 'create' %}
    
    <form class="form" method="get" action="/clinic/patients">
      <input type="hidden" name="tab" value="create">
      <div class="grid">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹
          {% set selected_type = prefill.patient_type if prefill and prefill.patient_type else (selected_patient_type or 'trainee') %}
          <select name="patient_type" id="patient_type" onchange="togglePatientForms()">
            <option value="trainee" {% if selected_type=='trainee' %}selected{% endif %}>Ù…ØªØ¯Ø±Ø¨</option>
            <option value="employee" {% if selected_type=='employee' %}selected{% endif %}>Ù…ÙˆØ¸Ù</option>
          </select>
        </label>
      </div>

      
      <div id="form_trainee" style="margin-top:8px;">
        <div class="grid">
          <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ
            <input type="text" name="trainee_no" placeholder="Ù…Ø«Ø§Ù„: 123456" value="{{ prefill.trainee_no if prefill }}">
          </label>
        </div>
        <div class="actions">
          <button class="btn btn-secondary">ØªØ­Ù‚Ù‘Ù‚ / Ø¬Ù„Ø¨</button>
          <a class="btn" href="/clinic/patients?tab=create">ØªÙØ±ÙŠØº</a>
        </div>
      </div>
    </form>

    {# === ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ === #}
    {% if edit_profile %}
    <hr>
    <div class="alert alert-info">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©): ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ <strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</strong> Ùˆ<strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</strong> ÙÙ‚Ø·.</div>

    <form class="form" method="post" action="/clinic/patients/update_profile">
      <input type="hidden" name="patient_key" value="{{ edit_profile.patient_key }}">

      <div class="grid">
        <label>Ø§Ù„Ø§Ø³Ù…
          <input type="text" value="{{ edit_profile.full_name }}" readonly>
        </label>

        {% if edit_profile.patient_type == 'trainee' %}
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ
          <input type="text" value="{{ edit_profile.trainee_no }}" readonly>
        </label>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
          <input type="text" value="{{ id_clean(edit_profile.national_id) }}" readonly>
        </label>
        <label>Ø§Ù„ØªØ®ØµØµ
          <input type="text" value="{{ edit_profile.major or '' }}" readonly>
        </label>
        <label>Ø§Ù„ÙƒÙ„ÙŠØ©
          <input type="text" value="{{ edit_profile.college or '' }}" readonly>
        </label>
        {% else %}
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
          <input type="text" value="{{ edit_profile.employee_no }}" readonly>
        </label>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
          <input type="text" value="{{ id_clean(edit_profile.national_id) }}" readonly>
        </label>
        {% endif %}

        <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
          <input type="text" name="mobile" value="{{ edit_profile.mobile or '' }}" placeholder="05xxxxxxxx">
        </label>

        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
          <input type="date" name="birth_date" value="{{ edit_profile.birth_date or '' }}">
        </label>
      </div>

      <div class="actions" style="margin-top:10px">
        <button class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <a class="btn btn-secondary" href="/clinic/visits/new?patient_key={{ edit_profile.patient_key|urlencode }}">Ø¨Ø¯Ø¡ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¢Ù†</a>
      </div>
    </form>
    {% endif %}

    {# === Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…ØªØ¯Ø±Ø¨ Ø¬Ø¯ÙŠØ¯ (Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ sf01) === #}
    {% if prefill and selected_type=='trainee' %}
    <hr>
    <div class="alert alert-success">ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ </div>

    <form class="form" method="post" action="/clinic/patients/create">
      <input type="hidden" name="patient_type" value="trainee">
      <input type="hidden" name="trainee_no"   value="{{ prefill.trainee_no }}">
      <input type="hidden" name="full_name"    value="{{ prefill.full_name }}">
      {# Ù†Ù†Ø¸Ù Ø§Ù„Ù‡ÙˆÙŠØ© Ù‚Ø¨Ù„ ØªÙ…Ø±ÙŠØ±Ù‡Ø§ ÙˆØ­ÙØ¸Ù‡Ø§ #}
      <input type="hidden" name="national_id"  value="{{ id_clean(prefill.national_id) }}">
      <input type="hidden" name="major"        value="{{ prefill.major }}">
      <input type="hidden" name="college"      value="{{ prefill.college }}">

      <div class="grid">
        <label>Ø§Ù„Ø§Ø³Ù… (Ù…Ù† sf01)
          <input type="text" value="{{ prefill.full_name }}" readonly>
        </label>
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ
          <input type="text" value="{{ prefill.trainee_no }}" readonly>
        </label>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©
          <input type="text" value="{{ id_clean(prefill.national_id) }}" readonly>
        </label>
        <label>Ø§Ù„ØªØ®ØµØµ
          <input type="text" value="{{ prefill.major }}" readonly>
        </label>
        <label>Ø§Ù„ÙƒÙ„ÙŠØ©
          <input type="text" value="{{ prefill.college }}" readonly>
        </label>
        <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
          <input type="text" name="mobile" value="{{ prefill.mobile or '' }}" placeholder="05xxxxxxxx">
        </label>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          <input type="date" name="birth_date" value="{{ prefill.birth_date or '' }}">
        </label>
      </div>

      <div class="actions" style="margin-top:10px">
        <button class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ</button>
        <a class="btn btn-secondary" href="/clinic/visits/new?patient_key=T:{{ prefill.trainee_no }}">Ø¨Ø¯Ø¡ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¢Ù†</a>
      </div>
    </form>
    {% endif %}

    
    <div id="form_employee" style="margin-top:8px; display:none;">
      <form class="form" method="post" action="/clinic/patients/create">
        <input type="hidden" name="patient_type" value="employee">
        <div class="grid">
          <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
            <input type="text" name="employee_no" placeholder="Ù…Ø«Ø§Ù„: 1001">
          </label>
          <label>Ø§Ù„Ø§Ø³Ù…
            <input type="text" name="emp_full_name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
          </label>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©
            <input type="text" name="emp_national_id" placeholder="10 Ø£Ø±Ù‚Ø§Ù…">
          </label>
          <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
            <input type="text" name="emp_mobile" placeholder="05xxxxxxxx">
          </label>
          <label>Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            <input type="text" name="department" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©">
          </label>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            <input type="date" name="birth_date">
          </label>
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ</button>
        </div>
      </form>
    </div>

  {% elif tab == 'search' %}
    <form class="form" method="get" action="/clinic/patients">
      <input type="hidden" name="tab" value="search">
      <div class="grid">
        <label>Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… ØªØ¯Ø±ÙŠØ¨ÙŠ/ÙˆØ¸ÙŠÙÙŠ/Ù‡ÙˆÙŠØ©/Ø§Ø³Ù…
          <input type="text" name="q" value="{{ q or '' }}" placeholder="Ù…Ø«Ø§Ù„: 123456 Ø£Ùˆ 1xxxxxxxxx Ø£Ùˆ Ø£Ø­Ù…Ø¯">
        </label>
      </div>
      <div class="actions" style="margin-top:8px">
        <button class="btn btn-primary">Ø¨Ø­Ø«</button>
        <a class="btn btn-secondary" href="/clinic/patients?tab=search">ØªÙØ±ÙŠØº</a>
      </div>
    </form>

    {% if results %}
      <div class="list-wrap">
        {% for r in results %}
          <div class="person-card">
            <div class="pc-header">
              <div class="pc-title">
                <span class="pc-name">{{ r.full_name }}</span>
                {% set isT = (r.patient_type or '') == 'trainee' %}
                <span class="pc-badge {{ 'pc-badge--trainee' if isT else 'pc-badge--employee' }}">
                  {{ 'Ù…ØªØ¯Ø±Ø¨' if isT else 'Ù…ÙˆØ¸Ù' }}
                </span>
              </div>
              <div class="pc-meta">
                <span>Ø§Ù„Ù†ÙˆØ¹: {{ 'Ù…ØªØ¯Ø±Ø¨' if isT else 'Ù…ÙˆØ¸Ù' }}</span>
                <span>Â·</span>
                <span>Ø§Ù„Ø±Ù‚Ù…: {{ r.trainee_no or r.employee_no }}</span>
                {% if r.mobile %}<span>Â·</span><span>Ø§Ù„Ø¬ÙˆØ§Ù„: {{ r.mobile }}</span>{% endif %}
              </div>
              {% if r.major or r.college %}
                <div class="pc-meta">
                  {% if r.major %}<span>Ø§Ù„ØªØ®ØµØµ: {{ r.major }}</span>{% endif %}
                  {% if r.college %}<span> â€” Ø§Ù„ÙƒÙ„ÙŠØ©: {{ r.college }}</span>{% endif %}
                </div>
              {% endif %}

              <div class="pc-meta">
                {% set lv = r.last_visit_at %}
                <span>Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©:
                  {% if lv.__class__.__name__ in ['datetime','date'] %}
                    {{ lv.strftime('%Y-%m-%d - %H:%M') }}
                  {% else %}
                    {{ (lv | replace('T',' ') | replace('+03:00','') | replace('+00:00',''))[:16] if lv }}
                  {% endif %}
                </span>
                <span>Â·</span>
                <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: {{ r.visit_count or 0 }}</span>
              </div>
            </div>

            <div class="pc-actions">
              <a class="btn btn-secondary" href="/clinic/visits/new?patient_key={{ r.patient_key|urlencode }}">Ø¨Ø¯Ø¡ Ø²ÙŠØ§Ø±Ø©</a>
              <a class="btn" href="/clinic/patients?tab=create&mode=edit&patient_key={{ r.patient_key|urlencode }}">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a>
            </div>

            {% if r.visits and r.visits|length %}
              <div class="pc-visits">
                <div class="pc-visits-title">Ø²ÙŠØ§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø© <small>(Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)</small> ğŸ—’ï¸</div>
                <ul class="timeline">
                  {% for v in r.visits %}
                    <li class="timeline-item">
                      <details class="tl-accordion" {% if loop.first %}open{% endif %}>
                        <summary class="tl-summary">
                          <span class="tl-date">
                            {% if v.visit_at.__class__.__name__ in ['datetime','date'] %}
                              {{ v.visit_at.strftime('%Y-%m-%d - %H:%M') }}
                            {% else %}
                              {{ (v.visit_at | replace('T',' ') | replace('+03:00','') | replace('+00:00',''))[:16] if v.visit_at }}
                            {% endif %}
                          </span>
                          <span class="tl-key">{{ r.patient_key }}</span>
                          <span class="tl-caret" aria-hidden="true">â–¾</span>
                        </summary>

                        <div class="tl-body">
                          {% set rj = v.rec_json or {} %}

                          {% if v.complaint %}<div><strong>Ø§Ù„Ø´ÙƒÙˆÙ‰:</strong> {{ v.complaint }}</div>{% endif %}
                          {% if v.diagnosis %}<div><strong>Ø§Ù„ØªØ´Ø®ÙŠØµ:</strong> {{ v.diagnosis }}</div>{% endif %}

                          {% if v.temp_c or v.bp_systolic or v.bp_diastolic or v.pulse_bpm or v.resp_rpm %}
                            <div class="tl-vitals muted">
                              <span>Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©:</span>
                              {% if v.temp_c %}<span>Ø­Ø±Ø§Ø±Ø© {{ '%.1f'|format(v.temp_c) }}Â°C</span>{% endif %}
                              {% if v.bp_systolic and v.bp_diastolic %}<span>â€” Ø¶ØºØ· {{ v.bp_systolic }}/{{ v.bp_diastolic }}</span>{% endif %}
                              {% if v.pulse_bpm %}<span>â€” Ù†Ø¨Ø¶ {{ v.pulse_bpm }} bpm</span>{% endif %}
                              {% if v.resp_rpm %}<span>â€” ØªÙ†ÙØ³ {{ v.resp_rpm }} rpm</span>{% endif %}
                            </div>
                          {% endif %}

                          {% if v.notes %}
                            <div class="tl-notes"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> {{ v.notes }}</div>
                          {% endif %}

                          {% if v.rec_json %}
                            <div class="tl-rec muted">
                              <strong>Ø§Ù„ØªÙˆØµÙŠØ©:</strong>
                              {% if rj.type == 'rest' %}
                                Ø±Ø§Ø­Ø© ({{ rj.days }} ÙŠÙˆÙ…)
                              {% elif rj.type == 'referral' %}
                                Ø¥Ø­Ø§Ù„Ø©: {{ rj.to }} â€” Ø§Ù„Ø³Ø¨Ø¨: {{ rj.summary }}
                              {% else %}
                                Ù„Ø§ ÙŠÙˆØ¬Ø¯
                              {% endif %}
                            </div>
                          {% endif %}

                          {# ===== Ø£Ø²Ø±Ø§Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© / Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„ØªÙˆØµÙŠØ© ===== #}
                          <div class="visit-print-actions">
                            {% if rj.type == 'rest' and rj.days and v.id %}
                              <a class="btn-print" href="/clinic/reports/rest_notice/by_visit?visit_id={{ v.id }}"
                                 target="_blank" rel="noopener">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</a>
                            {% endif %}
                            {% if rj.type == 'referral' and rj.to and v.id %}
                              <a class="btn-print" href="/clinic/reports/referral_notice/by_visit?visit_id={{ v.id }}"
                                 target="_blank" rel="noopener">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</a>
                            {% endif %}
                          </div>
                        </div>
                      </details>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% elif q %}
      <div class="card" style="margin-top:12px">
        <div class="card-head"><span class="card-icon">ğŸ”</span><h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3></div>
        <p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø¯Ø®Ù„: <strong>{{ q }}</strong></p>
      </div>
    {% endif %}
  {% endif %}
</div>

{# ===== Modal Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Ø³Ø§Ø¨Ù‚: ØªØ¹Ø¯ÙŠÙ„/Ø²ÙŠØ§Ø±Ø© ===== #}
{% if confirm == 'profile_found' and confirm_patient_key %}
<div id="exist-modal" class="x-modal is-open" role="dialog" aria-modal="true" aria-labelledby="exist-title">
  <div class="x-modal__backdrop"></div>
  <div class="x-modal__dialog">
    <div class="x-modal__header">
      <h3 id="exist-title">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ù…Ø³Ø¬Ù‘Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§</h3>
    </div>
    <div class="x-modal__body">
      <p>
        Ø¨ÙŠØ§Ù†Ø§Øª <strong>{{ confirm_name or 'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹' }}</strong> Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….
        Ù…Ø§Ø°Ø§ ØªÙˆØ¯ Ø£Ù† ØªÙØ¹Ù„ØŸ
      </p>
    </div>
    <div class="x-modal__footer">
      <a class="btn btn-primary" href="/clinic/visits/new?patient_key={{ confirm_patient_key|urlencode }}&msg=continue_existing">Ø¨Ø¯Ø¡ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
      <a class="btn" href="/clinic/patients?tab=create&mode=edit&patient_key={{ confirm_patient_key|urlencode }}">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ</a>
      <a class="btn btn-secondary" href="/clinic/patients?tab=create">Ø¥Ù„ØºØ§Ø¡</a>
    </div>
  </div>
</div>
<style>
  .x-modal{display:none}
  .x-modal.is-open{display:block;position:fixed;inset:0;z-index:9999}
  .x-modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
  .x-modal__dialog{
    position:relative;max-width:540px;margin:10vh auto;background:#fff;border-radius:12px;overflow:hidden;
    box-shadow:0 10px 30px rgba(0,0,0,.2);direction:rtl
  }
  .x-modal__header,.x-modal__footer{padding:14px 18px;background:#f7f8fa}
  .x-modal__body{padding:16px 18px}
  .x-modal__header h3{margin:0;font-size:1.15rem}
  .x-modal__footer{display:flex;gap:8px;justify-content:flex-start;flex-wrap:wrap}
</style>
{% endif %}

<style>
  /* === Ø´Ø§Ø±Ø© Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ === */
  .pc-badge{
    display:inline-block; padding:.15rem .5rem; border-radius:999px; font-size:.75rem; line-height:1;
    margin-inline-start:.5rem; vertical-align:middle; font-weight:700
  }
  .pc-badge--trainee{ background:#ecfdf5; color:#047857; border:1px solid #a7f3d0 }
  .pc-badge--employee{ background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe }

  /* === Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®Øµ === */
  .person-card{
    border:1px solid #e5e7eb; border-radius:14px; padding:14px 16px; margin-top:12px; background:#fff
  }
  .pc-header{ margin-bottom:8px }
  .pc-title{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
  .pc-name{ font-size:1.15rem; font-weight:800 }
  .pc-meta{ color:#6b7280; display:flex; gap:.4rem; flex-wrap:wrap; margin-top:4px }
  .pc-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }

  /* === Ø²ÙŠØ§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø© (Accordion + Timeline) === */
  .pc-visits{ margin-top:12px; background:#f9fafb; border:1px solid #eef2f7; border-radius:12px; padding:10px 12px }
  .pc-visits-title{ font-weight:800; color:#1f2937; margin-bottom:6px }
  .timeline{ list-style:none; margin:0; padding:0 }
  .timeline-item{ margin-bottom:10px }

  .tl-accordion{
    border:1px solid #e5e7eb; border-radius:10px; background:#fff;
  }
  .tl-summary{
    cursor:pointer; display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px; font-weight:700; color:#374151
  }
  .tl-summary::-webkit-details-marker{display:none}
  .tl-caret{ transition:transform .2s ease }
  .tl-accordion[open] .tl-caret{ transform:rotate(180deg) }

  .tl-body{ padding:8px 12px 12px; border-top:1px dashed #e5e7eb; color:#374151 }
  .tl-key{ color:#9ca3af; font-size:.8rem }
  .tl-vitals, .tl-rec{ margin-top:6px; color:#6b7280 }
  .tl-notes{ margin-top:6px }
  .muted{ color:#6b7280 }
  .list-wrap{ margin-top:12px }

  /* === Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø²ÙŠØ§Ø±Ø© === */
  .visit-print-actions{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap }
  .btn-print{
    display:inline-block; padding:6px 10px; border:1px solid #0f7d89; border-radius:8px;
    text-decoration:none; font-weight:700; color:#0f7d89; background:#e9f7f9;
  }
  .btn-print:hover{ background:#d8f1f5; }
</style>

<script>
  function togglePatientForms() {
    var sel = document.getElementById('patient_type');
    var t = sel ? sel.value : 'trainee';
    var formT = document.getElementById('form_trainee');
    var formE = document.getElementById('form_employee');
    if (formT) formT.style.display = (t === 'trainee') ? 'block' : 'none';
    if (formE) formE.style.display = (t === 'employee') ? 'block' : 'none';
  }
  (function(){ togglePatientForms(); })();
</script>

{% endblock %}
