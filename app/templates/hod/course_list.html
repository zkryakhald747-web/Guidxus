{% extends "base.html" %}

{% block breadcrumb %}
  <a href="/hod/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a> â€º <span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª</span>
{% endblock %}

{% block content %}

{% set kpis = (kpis if kpis is defined and kpis else {'total_active':0,'total_enrolled':0,'completion_rate':0}) %}
{% set courses = (courses if courses is defined else []) %}
{% set course_targets = (course_targets if course_targets is defined else {}) %}
{% set departments = (departments if departments is defined else []) %}
{% set filters = (filters if filters is defined else {'q':'','status_filter':'','department_id':'','date_from':'','date_to':''}) %}

{% if request.query_params.get('closed') %}
  <div class="alert alert-success" role="alert">
    âœ“ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­
  </div>
{% endif %}

{% if request.query_params.get('reopened') %}
  <div class="alert alert-success" role="alert">
    âœ“ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­
  </div>
{% endif %}

<section class="card card-prestige">
  <div class="card-head">
    <div class="card-icon">ğŸ“</div>
    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©</h3>
  </div>
  <div class="inline" style="justify-content:space-between;align-items:center;">
    <div class="muted">Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø¯ÙˆØ±Ø§Øª Ù‚Ø³Ù…Ùƒ: ØªØ¹Ø¯ÙŠÙ„ØŒ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ ØªØµØ¯ÙŠØ± ÙƒØ´ÙØŒ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø¶ÙˆØ±ØŒ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª.</div>
    <a class="btn btn-primary" href="/hod/courses/new">+ Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
  </div>
</section>

<section class="kpi-row">
  <div class="kpi-card"><div class="kpi-label">Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div><div class="kpi-value">{{ kpis.total_active or 0 }}</div></div>
  <div class="kpi-card"><div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</div><div class="kpi-value">{{ kpis.total_enrolled or 0 }}</div></div>
  <div class="kpi-card"><div class="kpi-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</div><div class="kpi-value">{{ kpis.completion_rate or 0 }}%</div></div>
</section>

<section class="card card-prestige">
  <div class="card-head">
    <div class="card-icon">ğŸ—‚ï¸</div>
    <h3>ØªØµÙÙŠØ©</h3>
  </div>
  <form class="filter-form" method="get" action="/hod/courses">
    <div class="grid">
      <label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        <input type="text" name="q" value="{{ filters.q or '' }}" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶">
      </label>

      <label>Ø§Ù„Ø­Ø§Ù„Ø©
        <select name="status_filter">
          <option value="" {{ 'selected' if not filters.status_filter }}>Ø§Ù„ÙƒÙ„</option>
          <option value="draft"     {{ 'selected' if filters.status_filter=='draft' }}>Ù…Ø³ÙˆØ¯Ø©</option>
          <option value="published" {{ 'selected' if filters.status_filter=='published' }}>Ù…Ù†Ø´ÙˆØ±Ø©</option>
          <option value="closed"    {{ 'selected' if filters.status_filter=='closed' }}>Ù…ØºÙ„Ù‚Ø©</option>
          <option value="finished"  {{ 'selected' if filters.status_filter=='finished' }}>Ù…Ù†ØªÙ‡ÙŠØ©</option>
        </select>
      </label>

      <label>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
        <select name="department_id">
          <option value="" {{ 'selected' if not filters.department_id }}>Ø§Ù„ÙƒÙ„</option>
          {% for dep in departments %}
            <option value="{{ dep.id }}"
              {% if filters.department_id and (filters.department_id|string) == (dep.id|string) %}selected{% endif %}>
              {{ dep.name }}
            </option>
          {% endfor %}
        </select>
      </label>

      <label>Ù…Ù† ØªØ§Ø±ÙŠØ® <input type="date" name="date_from" value="{{ filters.date_from or '' }}"></label>
      <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® <input type="date" name="date_to" value="{{ filters.date_to or '' }}"></label>
    </div>
    <div class="actions">
      <button class="btn btn-primary" type="submit">ØªØµÙÙŠØ©</button>
      <a class="btn btn-secondary" href="/hod/courses">Ù…Ø³Ø­</a>
    </div>
  </form>
</section>

<section class="card card-prestige">
  <div class="card-head">
    <div class="card-icon">ğŸ“‹</div>
    <h3>Ø§Ù„Ø¯ÙˆØ±Ø§Øª</h3>
  </div>

  {% if not courses %}
    <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©.</div>
  {% else %}
  <div class="table-wrap">
    <table class="tbl">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„ÙØªØ±Ø©</th>
          <th>Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</th>
          <th>Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ† / Ø§Ù„Ø³Ø¹Ø©</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for c in courses %}
        <tr>
          <td class="title-cell">
            <div class="title">{{ c.title }}</div>
            <div class="sub muted">
              Ø¢Ù„ÙŠØ© Ø§Ù„ØªÙ†ÙÙŠØ°:
              {% set mode_val = c.mode or '' %}
              {% if mode_val in ['in_person','Ø­Ø¶ÙˆØ±ÙŠ','Ø­Ø¶ÙˆØ±ÙŠ '] %}Ø­Ø¶ÙˆØ±ÙŠ
              {% elif mode_val in ['remote','online','Ø¹Ù† Ø¨ÙØ¹Ø¯','Ø¹Ù† Ø¨Ø¹Ø¯'] %}Ø¹Ù† Ø¨ÙØ¹Ø¯
              {% else %}â€”{% endif %}
              â€¢ {{ c.hours or 0 }} Ø³Ø§Ø¹Ø©
            </div>
          </td>

          <td>
            {% if c.status=='published' %}<span class="badge badge-live">Ù…Ù†Ø´ÙˆØ±Ø©</span>
            {% elif c.status=='draft' %}<span class="badge badge-draft">Ù…Ø³ÙˆØ¯Ø©</span>
            {% elif c.status=='finished' %}<span class="badge badge-finished">Ù…Ù†ØªÙ‡ÙŠØ©</span>
            {% else %}<span class="badge badge-closed">Ù…ØºÙ„Ù‚Ø©</span>{% endif %}
          </td>

          <td>{{ c.start_date }} â€“ {{ c.end_date }}</td>

          <td class="t-wrap">
            {% set targets = course_targets.get(c.id, []) %}
            {% if targets and targets|length > 0 %}{{ targets|join('ØŒ ') }}
            {% else %}<span class="muted">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>{% endif %}
          </td>

          <td>{{ c.registered_count if c.registered_count is defined else 0 }} / {{ c.capacity or 'â€”' }}</td>

          <td class="actions-cell">
            <a class="btn btn-xs" href="/hod/courses/{{ c.id }}/edit">ØªØ¹Ø¯ÙŠÙ„</a>
            
            <a class="btn btn-xs" href="/hod/courses/{{ c.id }}/roster.pdf?download=1">ÙƒØ´Ù ğŸ“„</a>
            <a class="btn btn-xs" href="/hod/attendance/{{ c.id }}">Ø­Ø¶ÙˆØ± âœ…</a>
            <a class="btn btn-xs" href="/hod/certificates/issue?course_id={{ c.id }}">Ø´Ù‡Ø§Ø¯Ø§Øª ğŸ–ï¸</a>
            {% if c.status!='closed' %}
              <a class="btn btn-xs danger" href="/hod/courses/{{ c.id }}/close">Ø¥ØºÙ„Ø§Ù‚ ğŸ”’</a>
            {% elif c.status=='closed' %}
              <a class="btn btn-xs warning" href="/hod/courses/{{ c.id }}/reopen">Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ ğŸ”“</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</section>

{% endblock %}
