{% extends "base.html" %}

{% block breadcrumb %}
  <a href="/admin/">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</a> â€º <a href="/admin/users">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</a> â€º
  <span>{{ 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯' if mode == 'create' else 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…' }}</span>
{% endblock %}

{% block content %}

<style>
  .form-card { max-width: 720px; margin: 0 auto; }
  .field { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
  .field label span { font-weight:700; }
  .error { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; padding:10px; border-radius:10px; margin-bottom:12px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width: 640px){ .row { grid-template-columns: 1fr; } }
  .hint { color:#6b7280; font-size:.9rem; }
</style>

<div class="card form-card">
  <div class="card-head">
    <div class="card-icon">ğŸ‘¤</div>
    <h3>{{ 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…' if mode == 'create' else 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…' }}</h3>
  </div>

  {% if error %}
    <div class="error">{{ error }}</div>
  {% endif %}

  <form method="post">
    <div class="row">
      <div class="field">
        <label><span>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</span>
          <input name="full_name" required value="{{ user.full_name if user else '' }}">
        </label>
      </div>
      <div class="field">
        <label><span>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
          <input name="username" required value="{{ user.username if user else '' }}">
        </label>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label><span>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± {{ '(Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©)' if mode=='edit' else '' }}</span>
          <input name="password" type="password" {{ '' if mode=='edit' else 'required' }}>
        </label>
      </div>
      {% set role_ctx = current_user_role or {} %}
      {% if role_ctx.get('is_admin') %}
      <div class="field">
        <label class="actions" style="margin-top: 28px;">
          <input type="checkbox" name="is_admin_f" id="is_admin_checkbox" {% if user and user.is_admin %}checked{% endif %}>
          <span>Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù† (ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©)</span>
        </label>
      </div>
      {% endif %}
    </div>

    <div class="row">
      {% if role_ctx.get('is_admin') %}
      <div class="field">
        <label class="actions">
          <input type="checkbox" name="is_college_admin_f" id="is_college_admin_checkbox" {% if user and user.is_college_admin %}checked{% endif %}>
          <span>Ø£Ø¯Ù…Ù† ÙƒÙ„ÙŠØ©</span>
        </label>
        <div id="college_admin_field" style="margin-top:8px; {% if not (user and user.is_college_admin) %}display:none;{% endif %}">
          <label><span>Ø§Ù„ÙƒÙ„ÙŠØ© <span style="color:#e00">*</span></span>
            <select name="college_admin_college" id="college_admin_select" {% if user and user.is_college_admin or is_college_admin_f %}required{% endif %}>
              <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ© --</option>
              {% for c in colleges or [] %}
                <option value="{{ c }}"
                  {% if (user and user.college_admin_college and user.college_admin_college|trim == c) %}selected{% endif %}>
                  {{ c }}
                </option>
              {% endfor %}
            </select>
          </label>
          <div class="hint">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ø£Ø¯Ù…Ù† Ù„ÙƒÙ„ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.</div>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="row">
      <div class="field">
        {% if role_ctx.get('is_admin') or role_ctx.get('is_college_admin') %}
        <label class="actions">
          <input id="is_hod_checkbox" type="checkbox" name="is_hod_f" {% if user and user.is_hod %}checked{% endif %}>
          <span>Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù…</span>
        </label>
        <div id="college_field" style="margin-top:8px; {% if not (user and user.is_hod) %}display:none;{% endif %}">
          <label><span>Ø§Ù„ÙƒÙ„ÙŠØ© <span style="color:#e00">*</span></span>
            <select name="hod_college" id="hod_college_select" {% if user and user.is_hod or (is_hod_f or selected_hod_college) %}required{% endif %}>
              <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„ÙŠØ© --</option>
              {% for c in colleges or [] %}
                <option value="{{ c }}"
                  {% if (user and user.hod_college and user.hod_college|trim == c) 
 					or (selected_hod_college and selected_hod_college == c) %}selected{% endif %}>
                  {{ c }}
                </option>
              {% endfor %}
            </select>
          </label>
          <div class="hint">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù… Ù„ÙƒÙ„ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.</div>
        </div>
        <div id="departments_field" style="margin-top:8px; {% if not (user and user.is_hod) %}display:none;{% endif %}">
          <label><span>Ø§Ù„Ù‚Ø³Ù… <span style="color:#e00">*</span></span>
            <select name="head_user_department_id" id="department_select" {% if user and user.is_hod or (is_hod_f or selected_hod_college) %}required{% endif %}>
              <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
              {% for dept in departments or [] %}
                <option value="{{ dept.id }}"
                  {% if user and user.headed_departments and dept.id in user.headed_departments|map(attribute='id')|list %}selected{% endif %}
                  data-college="{{ dept.college|trim }}">
                  {{ dept.college }} - {{ dept.name }}
                </option>
              {% endfor %}
            </select>
          </label>
          <div class="hint">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù… Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</div>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label class="actions">
          <input type="checkbox" name="is_doc_f" id="is_doc_checkbox" {% if user and user.is_doc %}checked{% endif %}{% if role_ctx.get('is_hod') and mode=='create' %} checked{% endif %}>
          <span>Ø·Ø¨ÙŠØ¨</span>
        </label>
        <div class="hint">Ø±Ø®ØµØ© Ø§Ù„Ø·Ø¨ÙŠØ¨ ØªÙ…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙˆØ§Ù„ØµÙŠØ¯Ù„ÙŠØ© ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†.</div>
      </div>
    </div>

    <div class="actions" style="margin-top:10px;">
      <button class="btn btn-primary" type="submit">Ø­ÙØ¸</button>
      <a class="btn btn-secondary" href="/admin/users">Ø±Ø¬ÙˆØ¹ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a>
    </div>
  </form>
</div>

<script>
  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙƒÙ„ÙŠØ© ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… Ø­Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø± "Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù…"
  const hodCheckbox = document.getElementById('is_hod_checkbox');
  const collegeField = document.getElementById('college_field');
  const departmentsField = document.getElementById('departments_field');
  const collegeSelect = document.getElementById('hod_college_select');
  const departmentSelect = document.getElementById('department_select');
  
  function filterDepartmentsByCollege() {
    const selectedCollege = collegeSelect ? collegeSelect.value.trim() : '';
    if (!departmentSelect) return;
    
    const options = departmentSelect.querySelectorAll('option');
    options.forEach(opt => {
      if (opt.value === '') {
        opt.style.display = 'block';
        return;
      }
      const optCollege = opt.getAttribute('data-college') || '';
      if (selectedCollege && optCollege !== selectedCollege) {
        opt.style.display = 'none';
      } else {
        opt.style.display = 'block';
      }
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ©
    if (departmentSelect.value && departmentSelect.options[departmentSelect.selectedIndex].style.display === 'none') {
      departmentSelect.value = '';
    }
  }
  
  if (hodCheckbox) {
    hodCheckbox.addEventListener('change', function() {
      const isChecked = this.checked;
      if (collegeField) collegeField.style.display = isChecked ? 'block' : 'none';
      if (departmentsField) departmentsField.style.display = isChecked ? 'block' : 'none';
      if (!isChecked) {
        if (collegeSelect) collegeSelect.value = "";
        if (departmentSelect) departmentSelect.value = "";
      }
    });
  }
  
  if (collegeSelect) {
    collegeSelect.addEventListener('change', filterDepartmentsByCollege);
  }
  
  // ØªØµÙÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', filterDepartmentsByCollege);
  } else {
    filterDepartmentsByCollege();
  }
  
  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ„ÙŠØ© Ù„Ø£Ø¯Ù…Ù† Ø§Ù„ÙƒÙ„ÙŠØ©
  const collegeAdminCheckbox = document.getElementById('is_college_admin_checkbox');
  const collegeAdminField = document.getElementById('college_admin_field');
  const collegeAdminSelect = document.getElementById('college_admin_select');
  const adminCheckbox = document.getElementById('is_admin_checkbox');
  
  if (collegeAdminCheckbox) {
    collegeAdminCheckbox.addEventListener('change', function() {
      if (collegeAdminField) {
        collegeAdminField.style.display = this.checked ? 'block' : 'none';
        if (!this.checked && collegeAdminSelect) {
          collegeAdminSelect.value = "";
        }
      }
      // Ø¥Ø°Ø§ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø£Ø¯Ù…Ù† Ø§Ù„ÙƒÙ„ÙŠØ©ØŒ Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†
      if (this.checked && adminCheckbox) {
        adminCheckbox.checked = false;
      }
    });
  }
  
  if (adminCheckbox) {
    adminCheckbox.addEventListener('change', function() {
      // Ø¥Ø°Ø§ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†ØŒ Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø£Ø¯Ù…Ù† Ø§Ù„ÙƒÙ„ÙŠØ©
      if (this.checked && collegeAdminCheckbox) {
        collegeAdminCheckbox.checked = false;
        if (collegeAdminField) collegeAdminField.style.display = 'none';
        if (collegeAdminSelect) collegeAdminSelect.value = "";
      }
    });
  }
</script>

{% endblock %}
