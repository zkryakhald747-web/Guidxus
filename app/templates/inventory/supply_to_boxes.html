{% extends "base.html" %}

{% block breadcrumb %}
  <a href="/inventory/">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</a> â€º <span>Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆÙŠØ© Ù„Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚</span>
{% endblock %}

{% block content %}

<style>
  .page-header {
    background: linear-gradient(180deg, #fef3c7 0%, #fde68a 100%);
    border-left: 4px solid #d97706;
    padding: 24px;
    margin-bottom: 24px;
    border-radius: 8px;
  }
  
  .page-title {
    font-size: 2rem;
    color: #92400e;
    margin: 0 0 8px 0;
    font-weight: 800;
  }
  
  .page-subtitle {
    color: #b45309;
    font-size: 0.95rem;
    margin: 0;
  }

  .main-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }
  
  @media (max-width: 1200px) {
    .main-content {
      grid-template-columns: 1fr;
    }
  }

  .section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .section-title {
    color: #92400e;
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© */
  .drugs-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }

  .drugs-table th {
    background: #fef3c7;
    color: #92400e;
    padding: 12px 10px;
    text-align: right;
    font-weight: 700;
    font-size: 0.9rem;
  }

  .drugs-table td {
    padding: 12px 10px;
    border-bottom: 1px solid #f3e8ff;
    font-size: 0.95rem;
  }

  .drugs-table tr:hover {
    background: #fef3c7;
  }

  .drug-name {
    font-weight: 600;
    color: #92400e;
  }

  .qty-low {
    color: #dc2626;
    font-weight: 600;
  }

  .qty-normal {
    color: #16a34a;
    font-weight: 600;
  }

  .select-drug-btn {
    background: #d97706;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .select-drug-btn:hover {
    background: #b45309;
    transform: translateY(-2px);
  }

  /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ© */
  .action-form {
    background: #fffbeb;
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #d97706;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    color: #92400e;
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 0.95rem;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d97706;
    border-radius: 6px;
    font-size: 0.95rem;
    font-family: inherit;
    background: white;
    color: #1e293b;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #f59e0b;
    box-shadow: 0 0 0 3px rgba(217,119,6,0.1);
  }

  .form-group select option {
    color: #1e293b;
  }

  .selected-drug-info {
    background: white;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 12px;
    border-left: 4px solid #d97706;
  }

  .selected-drug-info p {
    margin: 4px 0;
    font-size: 0.9rem;
  }

  .selected-drug-info strong {
    color: #92400e;
  }

  .add-btn {
    width: 100%;
    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .add-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(217,119,6,0.3);
  }

  .add-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .alert {
    padding: 14px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.95rem;
    animation: slideIn 0.3s ease;
  }

  .alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
  }

  .alert-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  .no-drug-message {
    text-align: center;
    color: #64748b;
    padding: 20px;
    font-style: italic;
  }

  /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
  .search-bar {
    margin-bottom: 16px;
  }

  .search-bar input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d97706;
    border-radius: 6px;
    font-size: 0.95rem;
  }

  .table-container {
    overflow-x: auto;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }
</style>


{% if msg %}
  {% if msg == 'drug_added_to_box_successfully' %}
    <div class="alert alert-success">
      âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªÙ… Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ§Ù„ØµÙŠØ¯Ù„ÙŠØ©!
    </div>
  {% endif %}
{% endif %}


<div class="page-header">
  <h1 class="page-title">ğŸ’‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆÙŠØ© Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø³Ø¹Ø§ÙØ§Øª</h1>
  <p class="page-subtitle">Ø§Ø®ØªØ± Ø¯ÙˆØ§Ø¡ ÙˆØµÙ†Ø¯ÙˆÙ‚ ÙˆÙƒÙ…ÙŠØ©ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©. Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ§Ù„ØµÙŠØ¯Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
</div>

<div class="main-content">
  
  <div class="section">
    <h2 class="section-title">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</h2>
    
    <div class="search-bar">
      <input 
        type="text" 
        id="drugSearch" 
        placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙˆØ§Ø¡ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..."
      >
    </div>

    <div class="table-container">
      <table class="drugs-table">
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</th>
            <th>Ø§Ù„ÙƒÙˆØ¯</th>
            <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
            <th>Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</th>
            <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="drugsTableBody">
          {% if drugs %}
            {% for drug in drugs %}
            <tr class="drug-row" data-drug-id="{{ drug.id }}">
              <td>
                <span class="drug-name">{{ drug.trade_name }}</span>
                {% if drug.generic_name %}
                  <div style="font-size: 0.8rem; color: #64748b;">{{ drug.generic_name }}</div>
                {% endif %}
              </td>
              <td>{{ drug.drug_code }}</td>
              <td>
                <span class="{% if drug.warehouse_qty < 5 %}qty-low{% else %}qty-normal{% endif %}">
                  {{ drug.warehouse_qty }}
                </span>
              </td>
              <td>
                <span class="{% if drug.pharmacy_qty < 5 %}qty-low{% else %}qty-normal{% endif %}">
                  {{ drug.pharmacy_qty }}
                </span>
              </td>
              <td>
                {% if drug.expiry_date %}
                  {% if drug.expiry_date < today %}
                    <span style="color: #dc2626; font-weight: 600;">âš ï¸ {{ drug.expiry_date }}</span>
                  {% else %}
                    <span style="color: #059669;">âœ… {{ drug.expiry_date }}</span>
                  {% endif %}
                {% else %}
                  <span style="color: #6b7280;">-</span>
                {% endif %}
              </td>
              <td>
                <button 
                  class="select-drug-btn"
                  onclick="selectDrug({{ drug.id }}, '{{ drug.trade_name }}', {{ drug.warehouse_qty }}, '{{ drug.unit }}', '{{ drug.expiry_date or '' }}')"
                >
                  Ø§Ø®ØªØ±
                </button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="no-drug-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  
  <div class="section">
    <h2 class="section-title">â• Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©</h2>
    
    <form class="action-form" onsubmit="submitAdd(event)">
      <div id="selectedDrugInfo" class="no-drug-message">Ø§Ø®ØªØ± Ø¯ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ø§Ù†Ø¨Ùƒ</div>

      <div class="form-group">
        <label for="boxSelect">Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ğŸ“¦</label>
        <select id="boxSelect" name="box_id" required>
          <option value="">-- Ø§Ø®ØªØ± ØµÙ†Ø¯ÙˆÙ‚ --</option>
          {% for box in boxes %}
          <option value="{{ box.id }}">{{ box.box_name }} ({{ box.location }})</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="quantityInput">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§</label>
        <input 
          type="number" 
          id="quantityInput" 
          name="quantity"
          min="1"
          placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©"
          required
        >
        <div id="availableQtyWarning" style="margin-top: 6px; font-size: 0.85rem;"></div>
      </div>

      <div class="form-group">
        <label for="expiryDateInput">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ğŸ“…</label>
        <input 
          type="date" 
          id="expiryDateInput" 
          name="expiry_date"
          placeholder="Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®"
        >
        <div id="expiryDateWarning" style="margin-top: 6px; font-size: 0.85rem;"></div>
      </div>

      <button type="submit" class="add-btn" id="addBtn" disabled>
        â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚
      </button>
    </form>
  </div>
</div>

<script>
  let selectedDrug = null;

  function selectDrug(drugId, drugName, warehouseQty, unit, expiryDate) {
    const today = new Date().toISOString().split('T')[0];
    const isExpired = expiryDate && expiryDate < today;
    
    // ÙˆØ¶Ø¹ ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„
    const expiryInput = document.getElementById('expiryDateInput');
    if (expiryDate) {
      expiryInput.value = expiryDate;
      
      // Ø¹Ø±Ø¶ ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù…Ù†ØªÙ‡ÙŠØ©
      const warningDiv = document.getElementById('expiryDateWarning');
      if (isExpired) {
        warningDiv.innerHTML = '<span style="color: #dc2626;">âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡</span>';
      } else {
        const expiryDate_obj = new Date(expiryDate);
        const daysUntilExpiry = Math.floor((expiryDate_obj - new Date(today)) / (1000 * 60 * 60 * 24));
        if (daysUntilExpiry < 30) {
          warningDiv.innerHTML = `<span style="color: #f59e0b;">âš ï¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù‚Ø±ÙŠØ¨Ø© (${daysUntilExpiry} ÙŠÙˆÙ…)</span>`;
        } else {
          warningDiv.innerHTML = '';
        }
      }
    } else {
      expiryInput.value = '';
      document.getElementById('expiryDateWarning').innerHTML = '';
    }
    
    selectedDrug = { 
      id: drugId, 
      name: drugName, 
      warehouse_qty: warehouseQty, 
      unit: unit,
      expiry_date: expiryDate,
      is_expired: isExpired
    };
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    const expiryDisplay = expiryDate ? 
      (isExpired ? `<p style="color: #dc2626;"><strong>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</strong> âš ï¸ ${expiryDate} <span style="font-size: 0.85rem;">(Ø§Ù†ØªÙ‡Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©)</span></p>` :
       `<p style="color: #059669;"><strong>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</strong> âœ… ${expiryDate}</p>`) :
      `<p style="color: #6b7280;"><strong>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</strong> ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©</p>`;
    
    document.getElementById('selectedDrugInfo').innerHTML = `
      <strong>âœ“ Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±:</strong><br>
      <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${drugName}</p>
      <p><strong>Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong> <span style="color: #d97706; font-weight: 600;">${warehouseQty} ${unit}</span></p>
      ${expiryDisplay}
    `;
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
    document.getElementById('addBtn').disabled = false;
    
    // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ±
    updateQtyWarning();
  }

  function updateQtyWarning() {
    const qty = parseInt(document.getElementById('quantityInput').value) || 0;
    if (selectedDrug && qty > selectedDrug.warehouse_qty) {
      document.getElementById('availableQtyWarning').innerHTML = 
        `âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${qty}) Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…ØªØ§Ø­ (${selectedDrug.warehouse_qty})`;
      document.getElementById('availableQtyWarning').style.color = '#dc2626';
    } else {
      document.getElementById('availableQtyWarning').innerHTML = '';
    }
  }

  document.getElementById('quantityInput').addEventListener('change', updateQtyWarning);
  document.getElementById('quantityInput').addEventListener('input', updateQtyWarning);

  function submitAdd(event) {
    event.preventDefault();
    
    if (!selectedDrug) {
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ§Ø¡ Ø£ÙˆÙ„Ø§Ù‹');
      return;
    }

    const quantity = parseInt(document.getElementById('quantityInput').value);
    const boxId = document.getElementById('boxSelect').value;

    if (quantity > selectedDrug.warehouse_qty) {
      alert(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù‡ÙŠ ${selectedDrug.warehouse_qty} ÙÙ‚Ø·`);
      return;
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ€ POST
    const formData = new FormData();
    formData.append('drug_id', selectedDrug.id);
    formData.append('box_id', boxId);
    formData.append('quantity', quantity);
    
    const expiryDate = document.getElementById('expiryDateInput').value;
    if (expiryDate) {
      formData.append('expiry_date', expiryDate);
    }

    fetch('/inventory/supply-to-boxes/process', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        setTimeout(() => {
          window.location.href = '/inventory/supply-to-boxes?msg=drug_added_to_box_successfully';
        }, 500);
      } else {
        alert(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
    });
  }

  // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
  document.getElementById('drugSearch').addEventListener('keyup', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.drug-row');
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });

  // Ø¥Ø°Ø§ ØªÙ… ØªÙ…Ø±ÙŠØ± drug_id Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ Ø§Ø®ØªØ±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  const urlParams = new URLSearchParams(window.location.search);
  const preselectedDrugId = urlParams.get('drug_id');
  const preselectedDrugName = urlParams.get('drug_name');
  
  if (preselectedDrugId && preselectedDrugName) {
    document.addEventListener('DOMContentLoaded', function() {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø±Ù‡
      const rows = document.querySelectorAll('.drug-row');
      rows.forEach(row => {
        const rowDrugId = parseInt(row.getAttribute('data-drug-id'));
        if (rowDrugId === parseInt(preselectedDrugId)) {
          // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„ØµÙ
          const cells = row.querySelectorAll('td');
          const warehouseQty = parseInt(cells[2].textContent) || 0;
          
          // Ø§ÙØªØ±Ø§Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø© ÙƒÙ€ 'Ø¹Ø¯Ø¯'
          let unit = 'Ø¹Ø¯Ø¯';
          
          // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ§Ø¡
          selectDrug(parseInt(preselectedDrugId), decodeURIComponent(preselectedDrugName), warehouseQty, unit);
          
          // ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„ÙƒÙ…ÙŠØ©
          document.getElementById('quantityInput').focus();
        }
      });
    });
  }

  // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
  setTimeout(() => {
    const alert = document.querySelector('.alert');
    if (alert) {
      alert.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => alert.remove(), 300);
    }
  }, 5000);
</script>

{% endblock %}
