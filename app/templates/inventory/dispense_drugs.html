{% extends "base.html" %}

{% block breadcrumb %}
  <a href="/inventory/">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</a> â€º <span>ØµØ±Ù Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</span>
{% endblock %}

{% block content %}

<style>
  .page-header {
    background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%);
    border-left: 4px solid #0284c7;
    padding: 24px;
    margin-bottom: 24px;
    border-radius: 8px;
  }
  
  .page-title {
    font-size: 2rem;
    color: #0c4a6e;
    margin: 0 0 8px 0;
    font-weight: 800;
  }
  
  .page-subtitle {
    color: #0c63e4;
    font-size: 0.95rem;
    margin: 0;
  }

  .main-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }
  
  @media (max-width: 1200px) {
    .main-content {
      grid-template-columns: 1fr;
    }
  }

  .section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .section-title {
    color: #0c4a6e;
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© */
  .drugs-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }

  .drugs-table th {
    background: #e0f2fe;
    color: #0c4a6e;
    padding: 12px 10px;
    text-align: right;
    font-weight: 700;
    font-size: 0.9rem;
  }

  .drugs-table td {
    padding: 12px 10px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 0.95rem;
  }

  .drugs-table tr:hover {
    background: #f0f9ff;
  }

  .drug-name {
    font-weight: 600;
    color: #0c4a6e;
  }

  .qty-low {
    color: #dc2626;
    font-weight: 600;
  }

  .qty-normal {
    color: #16a34a;
    font-weight: 600;
  }

  .select-drug-btn {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .select-drug-btn:hover {
    background: #2563eb;
    transform: translateY(-2px);
  }

  /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØµØ±Ù */
  .dispense-form {
    background: #f0f9ff;
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #0284c7;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    color: #0c4a6e;
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 0.95rem;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #0284c7;
    border-radius: 6px;
    font-size: 0.95rem;
    font-family: inherit;
    background: white;
    color: #1e293b;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #0ea5e9;
    box-shadow: 0 0 0 3px rgba(2,132,199,0.1);
  }

  .form-group select option {
    color: #1e293b;
  }

  .selected-drug-info {
    background: white;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 12px;
    border-left: 4px solid #0284c7;
  }

  .selected-drug-info p {
    margin: 4px 0;
    font-size: 0.9rem;
  }

  .selected-drug-info strong {
    color: #0c4a6e;
  }

  .dispense-btn {
    width: 100%;
    background: linear-gradient(135deg, #0284c7 0%, #0c4a6e 100%);
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .dispense-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(2,132,199,0.3);
  }

  .dispense-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .alert {
    padding: 14px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.95rem;
  }

  .alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
  }

  .alert-info {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #bfdbfe;
  }

  .no-drug-message {
    text-align: center;
    color: #64748b;
    padding: 20px;
    font-style: italic;
  }

  /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
  .search-bar {
    margin-bottom: 16px;
  }

  .search-bar input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #0284c7;
    border-radius: 6px;
    font-size: 0.95rem;
  }

  .table-container {
    overflow-x: auto;
  }
</style>


{% if msg %}
  {% if msg == 'drug_dispensed_successfully' %}
    <div class="alert alert-success">
      âœ… ØªÙ… ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªÙ… Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ§Ù„ØµÙŠØ¯Ù„ÙŠØ©!
    </div>
  {% endif %}
{% endif %}


<div class="page-header">
  <h1 class="page-title">ğŸ’Š ØµØ±Ù Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø³Ø¹Ø§ÙØ§Øª</h1>
  <p class="page-subtitle">Ø§Ø®ØªØ± Ø¯ÙˆØ§Ø¡ ÙˆØµÙ†Ø¯ÙˆÙ‚ ÙˆÙƒÙ…ÙŠØ©ØŒ Ø«Ù… Ø§Ø¶ØºØ· ØµØ±Ù. Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ§Ù„ØµÙŠØ¯Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
</div>

<div class="main-content">
  
  <div class="section">
    <h2 class="section-title">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</h2>
    
    <div class="search-bar">
      <input 
        type="text" 
        id="drugSearch" 
        placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙˆØ§Ø¡ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..."
      >
    </div>

    <div class="table-container">
      <table class="drugs-table">
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</th>
            <th>Ø§Ù„ÙƒÙˆØ¯</th>
            <th>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</th>
            <th>Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="drugsTableBody">
          {% if drugs %}
            {% for drug in drugs %}
            <tr class="drug-row" data-drug-id="{{ drug.id }}">
              <td>
                <span class="drug-name">{{ drug.trade_name }}</span>
                {% if drug.generic_name %}
                  <div style="font-size: 0.8rem; color: #64748b;">{{ drug.generic_name }}</div>
                {% endif %}
              </td>
              <td>{{ drug.drug_code }}</td>
              <td>
                <span class="{% if drug.warehouse_qty < 5 %}qty-low{% else %}qty-normal{% endif %}">
                  {{ drug.warehouse_qty }}
                </span>
              </td>
              <td>
                <span class="{% if drug.pharmacy_qty < 5 %}qty-low{% else %}qty-normal{% endif %}">
                  {{ drug.pharmacy_qty }}
                </span>
              </td>
              <td>
                <button 
                  class="select-drug-btn"
                  onclick="selectDrug({{ drug.id }}, '{{ drug.trade_name }}', {{ drug.warehouse_qty }}, '{{ drug.unit }}')"
                >
                  Ø§Ø®ØªØ±
                </button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="no-drug-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  
  <div class="section">
    <h2 class="section-title">ğŸ”„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØµØ±Ù</h2>
    
    <form class="dispense-form" onsubmit="submitDispense(event)">
      <div id="selectedDrugInfo" class="no-drug-message">Ø§Ø®ØªØ± Ø¯ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ø§Ù†Ø¨Ùƒ</div>

      <div class="form-group">
        <label for="boxSelect">Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ğŸ“¦</label>
        <select id="boxSelect" name="box_id" required>
          <option value="">-- Ø§Ø®ØªØ± ØµÙ†Ø¯ÙˆÙ‚ --</option>
          {% for box in boxes %}
          <option value="{{ box.id }}">{{ box.box_name }} ({{ box.location }})</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="quantityInput">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ ØµØ±ÙÙ‡Ø§</label>
        <input 
          type="number" 
          id="quantityInput" 
          name="quantity"
          min="1"
          placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©"
          required
        >
        <div id="availableQtyWarning" style="margin-top: 6px; font-size: 0.85rem;"></div>
      </div>

      <button type="submit" class="dispense-btn" id="dispenseBtn" disabled>
        ğŸ’‰ ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡
      </button>
    </form>
  </div>
</div>

<script>
  let selectedDrug = null;

  function selectDrug(drugId, drugName, warehouseQty, unit) {
    selectedDrug = { id: drugId, name: drugName, warehouse_qty: warehouseQty, unit: unit };
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    document.getElementById('selectedDrugInfo').innerHTML = `
      <strong>âœ“ Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±:</strong><br>
      <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${drugName}</p>
      <p><strong>Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong> <span style="color: #16a34a; font-weight: 600;">${warehouseQty} ${unit}</span></p>
    `;
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
    document.getElementById('dispenseBtn').disabled = false;
    
    // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ±
    updateQtyWarning();
  }

  function updateQtyWarning() {
    const qty = parseInt(document.getElementById('quantityInput').value) || 0;
    if (selectedDrug && qty > selectedDrug.warehouse_qty) {
      document.getElementById('availableQtyWarning').innerHTML = 
        `âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${qty}) Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…ØªØ§Ø­ (${selectedDrug.warehouse_qty})`;
      document.getElementById('availableQtyWarning').style.color = '#dc2626';
    } else {
      document.getElementById('availableQtyWarning').innerHTML = '';
    }
  }

  document.getElementById('quantityInput').addEventListener('change', updateQtyWarning);
  document.getElementById('quantityInput').addEventListener('input', updateQtyWarning);

  function submitDispense(event) {
    event.preventDefault();
    
    if (!selectedDrug) {
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ§Ø¡ Ø£ÙˆÙ„Ø§Ù‹');
      return;
    }

    const quantity = parseInt(document.getElementById('quantityInput').value);
    const boxId = document.getElementById('boxSelect').value;

    if (quantity > selectedDrug.warehouse_qty) {
      alert(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù‡ÙŠ ${selectedDrug.warehouse_qty} ÙÙ‚Ø·`);
      return;
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    const url = `/inventory/dispense-drugs/process?drug_id=${selectedDrug.id}&box_id=${boxId}&quantity=${quantity}`;
    window.location.href = url;
  }

  // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
  document.getElementById('drugSearch').addEventListener('keyup', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.drug-row');
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });

  // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
  setTimeout(() => {
    const alert = document.querySelector('.alert');
    if (alert) {
      alert.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => alert.remove(), 300);
    }
  }, 5000);
</script>

<style>
  @keyframes slideOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }
</style>

{% endblock %}
